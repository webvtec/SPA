<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>NAILUXE NAILZ BY NAVIA</title>
<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://fonts.googleapis.com/css2?family=Zilla+Slab:wght@400;700&amp;display=swap" rel="stylesheet"/>
<style>
    body {
      font-family: 'Zilla Slab', serif;
      margin: 0;
      padding: 0;
      background-color: #FFFFFF;  /* (COLOUR ALLOWED TO CHANGE FOR CLIENT)*/
    }

    .header-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 48px;
      background-color: #FE5DC7;    /* (COLOUR ALLOWED TO CHANGE FOR CLIENT)*/
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .header-title {
      font-family: 'Zilla Slab', serif;
      font-size: 22px;
      font-weight: bold;
      background: linear-gradient(90deg, #abecd6, #f9d423, #24c6dc, #abecd6);  /* (COLOUR ALLOWED TO CHANGE FOR CLIENT)*/
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
      white-space: nowrap;
      text-align: center;
    }


    .menu-button {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      background-color: #61134A;  /* (COLOUR ALLOWED TO CHANGE FOR CLIENT)*/
      color: #FF69B4;  /* (COLOUR ALLOWED TO CHANGE FOR CLIENT)*/
      border: none;
      border-radius: 0px;
      cursor: pointer;
      height: 48px;
      width: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      padding: 0;
    }

    .menu {
      position: fixed;
      top: 48px;
      left: 0;
      width: 150px;
      background-color: rgba(0, 0, 0, 0.8);
      color: #98FF98;
      padding: 20px;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      height: auto;
      min-height: 100px;
      z-index: 999;
    }

    .menu.show {
      transform: translateX(0);
    }

    .menu a {
      display: block;
      color: white;
      margin-bottom: 15px;
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
    }

    h1 {
      text-align: center;
      color: #FE5DC7;  /*COLOUR TO CHANGE TEXT ON REXIEWS PAGE (ALLOWED TO CHANGE FOR CLIENT)*/
      margin-top: 80px;
    }

    form {
      max-width: 400px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    }

    form input,
    form select,
    form button {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    form button {
      background-color: #61134A;  /*COLOUR TO CHANGE BOOM NOW BUTTON (ALLOWED TO CHANGE FOR CLIENT)*/
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    form button:hover {
      background-color: #61134A;
    }

    #bookingMessage {
      text-align: center;
      font-weight: bold;
      color: green;
      margin-top: 20px;
    }

    .gallery-category {
      margin-top: 40px;
    }

    .gallery-category h3 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 22px;
      color: #FE5DC7;  /*COLOUR TO CHANGE MAIN PAGE TEXTS (ALLOWED TO CHANGE FOR CLIENT)*/
      text-transform: uppercase;
    }

    .gallery-wrapper {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 10px;
    }

    .gallery-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin-bottom: 30px;
}

    .gallery-grid img {
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
      width: 100%;
      height: 230px;
      object-fit: cover;
    }

    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    .menu a.admin-button {
      background-color: #6A0DAD;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
      font-weight: bold;
      display: block;
      margin: 50px auto 0;
      cursor: pointer;
      transition: background-color 0.3s ease;
      text-align: center;
      width: fit-content;
    }

    .menu a.admin-button:hover {
      background-color: #3700b3;
    }

    .location-button {
      position: absolute;
      right: 0px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #61134A;  /* (COLOUR ALLOWED TO CHANGE FOR CLIENT)*/
      color: red;
      border: none;
      padding: 0;
      border-radius: 0px;
      cursor: pointer;
      height: 48px;
      width: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      text-decoration: none;
    }

        .opening-hours {
  font-family: Arial, sans-serif;
  padding: 8px 0;      /* Optional spacing */
  border-top: 2px solid rgba(255, 255, 255, 0.2);
  border-bottom: 2px solid rgba(255, 255, 255, 0.2);
}

.opening-hours h3 {
  font-size: 15px;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 5px;
  color: #FE5DC7; /* (COLOUR ALLOWED TO CHANGE FOR CLIENT)*/
}

.opening-hours p {
  font-size: 13px;
  margin: 2px 0;
  color: #FFFFFF;   /* (COLOUR ALLOWED TO CHANGE FOR CLIENT)*/
}

.opening-hours p:last-child {
  color: #FFFFFF; /* (COLOUR ALLOWED TO CHANGE FOR CLIENT)*/
  font-weight: bold;
}

        .location-info {
  font-family: Arial, sans-serif;
  padding: 8px 0;     /* Optional spacing */
}

.location-info h3 {
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 5px;
  color: #FE5DC7; /* (COLOUR ALLOWED TO CHANGE FOR CLIENT)*/
}

.location-info p {
  font-size: 13px;
  margin: 0;
  color: rgba(255, 255, 255, 0.8); /* Slightly lighter than title */
}

    .separator-line {
  height: 2px;
  background-color: #5B5B5B;
  margin: 2px 0; /* Optional spacing */
    }


    /* Modal container */
#myBookingsModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: none; /* default hidden */
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* Modal box */
#myBookingsBox {
  background: #fff;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;   /* ✅ prevent overflowing screen */
  border-radius: 12px;
  overflow-y: auto;   /* ✅ allow scrolling when content is tall */
  position: relative;
  padding: 20px;
}

/* Close button */
#closeBookings {
  position: sticky;   /* ✅ stays visible when scrolling */
  top: 0;
  float: right;
  background: transparent;
  border: none;
  font-size: 24px;
  cursor: pointer;
  z-index: 10000;
}





/* Chatbot Styles - Add to existing <style> section */
.chatbot-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
}

.chatbot-toggle {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #FE5DC7, #61134A);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: transform 0.3s ease;
}

.chatbot-toggle:hover {
  transform: scale(1.1);
}

.chatbot-toggle span {
  color: white;
  font-size: 24px;
}

.chatbot-window {
  position: absolute;
  bottom: 70px;
  right: 0;
  width: 320px;
  height: 400px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  display: none;
  flex-direction: column;
  overflow: hidden;
}

.chatbot-header {
  background: linear-gradient(135deg, #FE5DC7, #61134A);
  color: white;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: bold;
}

.chatbot-close {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chatbot-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background: #f9f9f9;
}

.chatbot-message {
  margin-bottom: 12px;
  display: flex;
  align-items: flex-start;
}

.chatbot-message.user {
  justify-content: flex-end;
}

.chatbot-message .message-content {
  max-width: 80%;
  padding: 8px 12px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.4;
}

.chatbot-message.bot .message-content {
  background: #FE5DC7;
  color: white;
  border-bottom-left-radius: 4px;
}

.chatbot-message.user .message-content {
  background: #61134A;
  color: white;
  border-bottom-right-radius: 4px;
}

.chatbot-input-container {
  padding: 12px;
  background: white;
  border-top: 1px solid #eee;
  display: flex;
  gap: 8px;
}

.chatbot-input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 20px;
  outline: none;
  font-size: 14px;
}

.chatbot-send {
  background: #FE5DC7;
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.chatbot-typing {
  display: flex;
  gap: 4px;
  padding: 8px 12px;
  background: #FE5DC7;
  border-radius: 12px;
  border-bottom-left-radius: 4px;
  max-width: 80%;
}

.chatbot-typing span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: white;
  animation: typing 1.5s infinite;
}

.chatbot-typing span:nth-child(2) {
  animation-delay: 0.2s;
}

.chatbot-typing span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    opacity: 0.3;
  }
  30% {
    opacity: 1;
  }
}

    
  </style>
</head>
<body>
<div class="header-bar">
<button class="menu-button" onclick="toggleMenu()">☰</button>
<div class="header-title">NAILUXE NAILZ BY NAVIA</div>
<a class="location-button" href="https://maps.app.goo.gl/7MYNayosraXVDiTD6" target="_blank">📍</a>
</div>
<!-- ✅ Gallery Section (Now Wrapped) -->
<div class="content-section active" id="gallerySection">
<h2 style="text-align:center; margin-top:60px;"></h2>
<div id="galleryDisplay"></div>
</div>
<!-- ✅ Menu -->
<div class="menu" id="menu">
<a onclick="showSection('gallerySection'); closeMenu();">💅🏽 DESIGNS</a>
<a onclick="showSection('bookingSection'); closeMenu();">📆 BOOKING</a>
<a onclick="showSection('reviewsSection'); closeMenu();">⭐️ REVIEWS</a>
<div class="sidebar">
<!-- Opening Hours Section -->
<div class="opening-hours">
<h3>OPENING HOURS:</h3>
<p>Monday: 9:00 AM - 6:00 PM</p>
<p>Tuesday: Closed</p>
<p>Wednesday - Saturday 9:00 AM - 6:00 PM</p>
<p>Sunday: Closed</p>
</div>
<a class="admin-button" onclick="showUserBookings(); closeMenu();" style="display:block; text-align:center; font-size:15px; margin:10px auto; padding:10px 10px; background-color:#61134A; color:white; border-radius:6px; cursor:pointer; text-decoration:none; width:80%; white-space:nowrap; font-weight:bold; overflow:hidden; text-overflow:ellipsis;">
   MY BOOKINGS
    </a>
<a onclick="showPaymentInfo(); closeMenu();" 
   style="display:block; text-align:center; font-size:15px; margin:10px auto; padding:10px 10px; background-color:#61134A; color:white; border-radius:6px; cursor:pointer; text-decoration:none; width:80%; white-space:nowrap; font-weight:bold; overflow:hidden; text-overflow:ellipsis;"
   href="javascript:void(0);">
   PAYMENT INFO
</a>
    
<!-- Another Separator Line -->
<div class="separator-line"></div>
    
<div class="social-links" style="display:flex; justify-content:center; gap:35px; margin-top:25px;">
<!-- Instagram -->
<a href="https://www.instagram.com/nailz_by_navia?igsh=aGN4YTJ2cnUyNmhl" style="display:inline-block;" target="_blank">
  <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24">
    <defs>
      <linearGradient id="instagramGradient" x1="0%" y1="100%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#ffc107"/>
        <stop offset="25%" style="stop-color:#ff5722"/>
        <stop offset="50%" style="stop-color:#e91e63"/>
        <stop offset="75%" style="stop-color:#9c27b0"/>
        <stop offset="100%" style="stop-color:#673ab7"/>
      </linearGradient>
    </defs>
    <path fill="url(#instagramGradient)" d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
  </svg>
</a>

<!-- TikTok -->
<a href="https://www.tiktok.com/@nailzbynavia?_t=ZM-8zGEioEDb5s&_r=1" target="_blank" style="display:inline-block;">
  <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 448 512">
    <!-- Pink/Red shadow -->
    <path fill="#ff0050" d="M448 209.91a210.06 210.06 0 0 1-122.77-39.25v178.72A162.55 162.55 0 1 1 185 188.31v89.89a74.62 74.62 0 1 0 52.23 71.18V0h88a121.18 121.18 0 0 0 1.86 22.17A122.18 122.18 0 0 0 381 102.39a121.43 121.43 0 0 0 67 20.14z" transform="translate(3, 3)"/>
    
    <!-- Cyan shadow -->
    <path fill="#25f4ee" d="M448 209.91a210.06 210.06 0 0 1-122.77-39.25v178.72A162.55 162.55 0 1 1 185 188.31v89.89a74.62 74.62 0 1 0 52.23 71.18V0h88a121.18 121.18 0 0 0 1.86 22.17A122.18 122.18 0 0 0 381 102.39a121.43 121.43 0 0 0 67 20.14z" transform="translate(-3, -3)"/>
    
    <!-- Main white logo -->
    <path fill="#ffffff" d="M448 209.91a210.06 210.06 0 0 1-122.77-39.25v178.72A162.55 162.55 0 1 1 185 188.31v89.89a74.62 74.62 0 1 0 52.23 71.18V0h88a121.18 121.18 0 0 0 1.86 22.17A122.18 122.18 0 0 0 381 102.39a121.43 121.43 0 0 0 67 20.14z"/>
  </svg>
</a>
</div>


</div>
<!-- Another Separator Line -->
<div class="separator-line"></div>
<div class="location-info">
<h3>LOCATION:</h3>
<p>Shop #4, 1 Wesley road cheago plaza, Angellace beauty salon, Mandeville, Jamaica</p>
</div>
<!-- Another Separator Line -->
<div class="separator-line"></div>
<!-- Logout and Admin Buttons -->
<a onclick="logoutUser(); closeMenu();" style="display:block; text-align:center; margin:10px auto; padding:10px 20px; background-color:red; color:white; border-radius:6px; cursor:pointer; text-decoration:none; width:80%; font-weight:bold;">
       LOGOUT
    </a>
<a class="admin-button" onclick="login(); closeMenu();" style="display:block; text-align:center; margin:10px auto; padding:10px 20px; background-color:#61134A; color:white; border-radius:6px; text-decoration:none; width:80%; font-weight:bold;">
       ADMIN
    </a>
</div>
</div>

    <!-- Add this booking confirmation modal right after your existing modals -->
<div id="bookingModal" style="
  display:none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 10000;
">
  <div style="
    background: ;
    padding: 20px;
    border-radius: 12px;
    max-width: 450px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    position: relative;
  ">
    <h3 id="bookingModalTitle" style="margin: 10px 0; color: #FE5DC7; text-align: center;">
      Booking Confirmation
    </h3>
    <p id="bookingModalContent"></p>
  </div>
</div>

    
<!-- My Bookings Modal -->
<div id="myBookingsModal" style="
  display:none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 10000;
">
<div id="myBookingsBox" style="
    background:#fff;
    padding:20px;
    border-radius:12px;
    max-width:400px;
    width:90%;
    max-height:80vh;       /* ✅ keeps inside screen */
    overflow-y:auto;       /* ✅ scroll only content */
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
    position:relative;
  ">
<!-- Close Button -->
<button onclick="closeMyBookings()" style="
      position:sticky; top:0; right:0;
      float:right;
      background:#fff;
      border:none;
      font-size:24px;
      cursor:pointer;
      z-index:10001;
    ">✖</button>
<h3 style="margin:10px 0; color:#FE5DC7; text-align:center;">
      My Last 5 Bookings
    </h3>
<div id="myBookingsContent"></div>
</div>
</div>


<!-- Updated Booking Section -->
<div class="content-section" id="bookingSection">
<h1>BOOK APPOINTMENT</h1>
<form onsubmit="submitBooking(event)">
<label for="name">Name:</label>
<input id="name" required="" type="text"/>

<label for="phone">Phone Number:</label>
<input 
  id="phone" 
  type="tel" 
  inputmode="numeric" 
  maxlength="14" 
  placeholder="eg... (876) 123-4567" 
  required 
/>

<label for="date">Preferred Date:</label>
<input id="date" min="" onchange="loadAvailableSlots()" required="" type="date"/>

<!-- Time slots will appear here -->
<label for="selectedTime">Available Times:</label>
<select id="selectedTime" required="" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
<option value="">COMPLETE FORM TO SEE AVAILABLE SLOTS</option>
</select>

<!-- Manicure & Pedicure Services -->
<label for="manicurePedicureType">Manicure & Pedicure:</label>
<select id="manicurePedicureType" onchange="showEstimateTime(); loadAvailableSlots();">
<option value="NONE">NONE</option>
<option value="Female Manicure">Female Manicure — $2,000+</option>
<option value="Female Pedicure">Female Pedicure — $3,000</option>
<option value="Men's Manicure">Men's Manicure — $2,000</option>
<option value="Men's Pedicure">Men's Pedicure — $5,000</option>
</select>

<!-- Polish & Art Services -->
<label for="polishArtType">Polish & Art:</label>
<select id="polishArtType" onchange="showEstimateTime(); loadAvailableSlots();">
<option value="NONE">NONE</option>
<option value="Gel Polish Fingers">Gel Polish Fingers — $3,000</option>
<option value="Gel Polish Toes">Gel Polish Toes — $2,000+</option>
<option value="French Toes">French Toes — $2,500+</option>
<option value="Hand Painted French">Hand Painted French — $2,000+</option>
<option value="Nail Art">Nail Art — $300+</option>
</select>

<!-- Acrylic Services -->
<label for="acrylicType">Acrylic (Hands & Toes):</label>
<select id="acrylicType" onchange="showEstimateTime(); loadAvailableSlots();">
<option value="NONE">NONE</option>
<option value="XL Full Set">XL Full Set — $8,000+</option>
<option value="Long Full Set">Long Full Set — $7,000+</option>
<option value="Medium Full Set">Medium Full Set — $6,000+</option>
<option value="Short Full Set">Short Full Set — $5,000+</option>
<option value="Oval/Almond Medium">Oval/Almond Medium — $7,000+</option>
<option value="Oval Faded French (Medium)">Oval Faded French (Medium) — $7,500+</option>
<option value="Coffin">Coffin — $6,000+</option>
<option value="Nail Overlay (Short)">Nail Overlay (Short) — $4,500+</option>
<option value="Overlay & Gel Polish">Overlay & Gel Polish — $7,000+</option>
<option value="Refill & Gel Polish">Refill & Gel Polish — $5,500+</option>
<option value="Refill My Work (2–3 Weeks)">Refill My Work (2–3 Weeks) — $3,000+</option>
<option value="Reshape & Cutdown Nails">Reshape & Cutdown Nails — $1,200+</option>
<option value="Acrylic All Toes">Acrylic All Toes — $4,000+</option>
<option value="Acrylic Big Toes">Acrylic Big Toes — $2,500+</option>
<option value="Fix Acrylic Toes">Fix Acrylic Toes — $1,500+</option>
<option value="Refill Toes">Refill Toes — $2,000+</option>
</select>

<!-- Gel Services -->
<label for="gelType">Gel Services:</label>
<select id="gelType" onchange="showEstimateTime(); loadAvailableSlots();">
<option value="NONE">NONE</option>
<option value="Gel X (Long)">Gel X (Long) — $7,500+</option>
<option value="Gel X (Medium)">Gel X (Medium) — $6,500+</option>
<option value="Rebalanced Structured Gel">Rebalanced Structured Gel — $5,500+</option>
</select>

<!-- Other Services -->
<label for="otherType">Other Services:</label>
<select id="otherType" onchange="showEstimateTime(); loadAvailableSlots();">
<option value="NONE">NONE</option>
<option value="Soak Off Acrylic Fingers & Clean Up">Soak Off Acrylic Fingers & Clean Up — $1,500+</option>
<option value="Soak Off Toes">Soak Off Toes — $500+</option>
<option value="Gem Application">Gem Application — $300+</option>
<option value="Hair Brush">Hair Brush — $300+</option>
</select>

<p id="estimateTimeMessage" style="color: #FE5DC7; font-weight: bold;"></p>

<button type="submit">Book Now</button>
</form>
<p id="bookingMessage"></p>
</div>

    
<div class="content-section" id="reviewsSection">
<h1 style="text-align:center; color:#FE5DC7;">CLIENT REVIEWS</h1>
<div id="reviewPrompt" style="display:none; max-width:500px; margin:20px auto; 
            background-color:#e8d9fb; color:#6200ea; 
            border:1px solid #d1aaff; border-radius:6px; 
            padding:15px; text-align:center; font-weight:500;">
  Hi, how was your appointment? Please leave a review!
</div>
<form id="reviewForm" style="max-width:85%; margin:10px auto; text-align:center;">
<div style="max-width: 50%; margin: 0 auto;">
<input id="reviewName" placeholder="Your Name" required="" style="width:100%; margin-bottom:10px; padding:10px; border-radius:6px; border:1px solid #ccc;" type="text"/>
</div>
<textarea id="reviewComment" placeholder="Write your review..." required="" style="width:90%; height:80px; margin-bottom:10px; padding:10px; border-radius:6px; border:1px solid #ccc;"></textarea>
<div id="starRating" style="font-size:24px; margin-bottom:10px; cursor:pointer; color:#ccc;">
<span data-value="1">★</span>
<span data-value="2">★</span>
<span data-value="3">★</span>
<span data-value="4">★</span>
<span data-value="5">★</span>
</div>
<button style="background-color:#61134A; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;" type="submit">SUBMIT
      REVIEW</button>
</form>
<p id="reviewSubmitMsg" style="text-align:center; color:green;"></p>
<!-- Container where reviews will be loaded -->
<div id="reviewsContainer" style="max-width:100%; margin:20px auto;"></div>
</div>

<!-- Admin Login Modal -->
<div id="adminLoginModal" style="
  display:none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 10000;
">
<div style="
    background: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    max-width: 320px;
    width: 100%;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    position: relative;
  ">
<!-- Close button -->
<span onclick="closeAdminModal()" style="
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 20px;
      cursor: pointer;
      color: #999;
    ">×</span>
<h3 style="margin:10px 0 20px; color:#6200ea;">ADMIN LOGIN</h3>
<input id="adminEmail" placeholder="Email" style="width: 90%; margin-bottom:10px; padding:10px;
                  border:1px solid #ccc; border-radius:6px;" type="email"/>
<input id="adminPassword" placeholder="Password" style="width: 90%; margin-bottom:10px; padding:10px;
                  border:1px solid #ccc; border-radius:6px;" type="password"/>
<p id="adminLoginMsg" style="color:red; font-size:14px; display:none;"></p>
<button onclick="closeAdminModal()" style="
      background-color:#ccc; color:#333; border:none;
      padding:10px 20px; border-radius:6px; cursor:pointer;">
      Cancel
    </button>
<button onclick="attemptAdminLogin()" style="
      background-color:#6200ea; color:white; border:none;
      padding:10px 20px; border-radius:6px; cursor:pointer; margin-right:8px;">
      Login
    </button>
</div>
</div>


    <!-- Chatbot HTML - Add before closing </body> tag -->
<div class="chatbot-container">
  <button class="chatbot-toggle" onclick="toggleChat()">
    <span id="chatbot-icon">💬</span>
  </button>
  
  <div class="chatbot-window" id="chatbot-window">
    <div class="chatbot-header">
      <span>Chat with us!</span>
      <button class="chatbot-close" onclick="closeChat()">×</button>
    </div>
    
    <div class="chatbot-messages" id="chatbot-messages">
      <div class="chatbot-message bot">
        <div class="message-content">
          Hi! Welcome to NAILUXE NAILZ BY NAVIA! 😊 How can I help you today?
        </div>
      </div>
    </div>
    
    <div class="chatbot-input-container">
      <input 
        type="text" 
        class="chatbot-input" 
        id="chatbot-input" 
        placeholder="Type your message..."
        onkeypress="handleChatKeyPress(event)"
      />
      <button class="chatbot-send" onclick="sendChatMessage()">
        ➤
      </button>
    </div>
  </div>
</div>

<!-- ✅ Scripts -->
<script>
    let currentUser = null;

    const firebaseConfig = {
  apiKey: "AIzaSyDiNjbjKLAxuyWmVRxia3ysx5U5tW80DUA",
  authDomain: "nailzbynavia.firebaseapp.com",
  projectId: "nailzbynavia",
  storageBucket: "nailzbynavia.firebasestorage.app",
  messagingSenderId: "881466836828",
  appId: "1:881466836828:web:577b5087a68d7a637aa399"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    firebase.auth().onAuthStateChanged(user => {
  currentUser = user || null; // Store user if logged in, null if not
  loadReviews(currentUser);
});


    function login() {
  document.getElementById('adminLoginModal').style.display = 'flex';
}

function closeAdminModal() {
  document.getElementById('adminLoginModal').style.display = 'none';
  document.getElementById('adminLoginMsg').style.display = 'none'; // Hide error message

  // ✅ Clear inputs on close
  document.getElementById('adminEmail').value = "";
  document.getElementById('adminPassword').value = "";
}

function attemptAdminLogin() {
  const email = document.getElementById('adminEmail').value.trim();
  const password = document.getElementById('adminPassword').value.trim();
  const msg = document.getElementById('adminLoginMsg');

  // Hard-coded admin credentials
  const adminEmail = 'navoleneh@gmail.com';
  const adminPassword = 'Nailzbynavia4040$';

  if (email === adminEmail && password === adminPassword) {
    firebase.auth().signInWithEmailAndPassword(email, password)
      .then(() => {
        // ✅ Close modal immediately
        closeAdminModal();

        // ✅ Redirect to dashboard
        window.location.href = 'dashboard.html';
      })
      .catch(() => {
        msg.textContent = "You are not an admin user.";
        msg.style.display = "block";

        // ✅ Clear only password on error
        document.getElementById('adminPassword').value = "";
      });
  } else {
    msg.textContent = "You are not an admin user.";
    msg.style.display = "block";

    // ✅ Clear only password on wrong login
    document.getElementById('adminPassword').value = "";
  }
}

      function toggleMenu() {
  const menu = document.getElementById("menu");
  const button = document.querySelector(".menu-button");

  if (menu.classList.contains("show")) {
    closeMenu();
  } else {
    menu.classList.add("show");

    // ✅ Enable outside click listener
    document.addEventListener("click", outsideClickHandler);
  }

  function outsideClickHandler(event) {
    if (!menu.contains(event.target) && !button.contains(event.target)) {
      closeMenu();
      document.removeEventListener("click", outsideClickHandler);
    }
  }
}

function closeMenu() {
  const menu = document.getElementById("menu");
  menu.classList.remove("show");
}

function formatTimeInput() {
  let input = document.getElementById('timeInput');
  let value = input.value.replace(/\D/g, ''); // Keep only digits

  if (value.length === 0) {
    input.value = '';
    return;
  }

  if (value.length <= 2) {
    // For hour input like "1" or "12"
    input.value = value;
  } else if (value.length === 3) {
    // For input like "130" ➜ should show "1:30"
    input.value = `${value.slice(0, 1)}:${value.slice(1)}`;
  } else if (value.length === 4) {
    // For input like "1030" ➜ should show "10:30"
    input.value = `${value.slice(0, 2)}:${value.slice(2)}`;
  }
}

function selectPeriod(period) {
  document.getElementById('timePeriod').value = period;

  // Hide AM/PM buttons after selection
  document.getElementById('amBtn').style.display = 'none';
  document.getElementById('pmBtn').style.display = 'none';

  // Show selected period text (ensure no duplicates)
  const confirmation = document.getElementById('periodConfirmation');
  confirmation.innerText = `You selected ${period}`;
  confirmation.style.fontWeight = 'bold';
  confirmation.style.marginBottom = '10px';
}

    function showExtensionLengthOptions() {
  const extensionType = document.getElementById('nailExtensionType').value;
  const lengthContainer = document.getElementById('extensionLengthContainer');

  if (extensionType !== 'NONE') {
    lengthContainer.style.display = 'block';
  } else {
    lengthContainer.style.display = 'none';
  }
}

  function loadGallery(containerId) {
  const galleryContainer = document.getElementById(containerId);
  galleryContainer.innerHTML = '';

  db.collection('gallery').onSnapshot((querySnapshot) => {
    galleryContainer.innerHTML = '';

    const categories = {};

    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const imageUrl = data.url;
      const category = data.category || 'Uncategorized';

      if (!categories[category]) {
        categories[category] = [];
      }
      categories[category].push(imageUrl);
    });

    for (const category in categories) {
      galleryContainer.innerHTML += `
        <div class="gallery-category">
          <h3>${category}</h3>
          <div class="gallery-wrapper">
            <div class="gallery-grid" id="gallery-${category}"></div>
          </div>
          <div style="text-align:center; margin-top:7px;">
            <button 
              onclick="showSection('bookingSection')" 
              style="background-color:#61134A; color:#000; font-weight: bold; padding:10px 20px; border:none; border-radius:15px; cursor:pointer;">
              BOOK A SERVICE NOW
            </button>
          </div>
        </div>
      `;

      const categoryContainer = document.getElementById(`gallery-${category}`);
      categories[category].forEach((imageUrl) => {
        categoryContainer.innerHTML += `
          <div>
            <img src="${imageUrl}" alt="Design" style="margin-bottom:10px;">
          </div>
        `;
      });
    }
  });
}

// ✅ Force the Designs page to load immediately
document.addEventListener('DOMContentLoaded', function () {
  showSection('gallerySection');
  loadGallery('galleryDisplay');
});

    function convertToMinutes(timeStr) {
  let [time, period] = timeStr.split(' ');
  let [hours, minutes] = time.split(':').map(Number);

  if (period.toUpperCase() === 'PM' && hours !== 12) {
    hours += 12;
  }
  if (period.toUpperCase() === 'AM' && hours === 12) {
    hours = 0;
  }

  return (hours * 60) + minutes;
}

const businessHours = {
  'Sunday': null, // Closed
  'Wednesday': null, // Closed
  'Monday': { open: '9:00 AM', close: '6:00 PM' },
  'Tuesday': { open: '9:00 AM', close: '6:00 PM' },
  'Thursday': { open: '9:00 AM', close: '6:00 PM' },
  'Friday': { open: '9:00 AM', close: '6:00 PM' },
  'Saturday': { open: '9:00 AM', close: '6:00 PM' }
};

function showEstimateTime() {
    const manicurePedicure = document.getElementById('manicurePedicureType').value;
    const polishArt = document.getElementById('polishArtType').value;
    const acrylic = document.getElementById('acrylicType').value;
    const gel = document.getElementById('gelType').value;
    const other = document.getElementById('otherType').value;
    const estimateMessage = document.getElementById('estimateTimeMessage');

    // Check if no services are selected
    if (manicurePedicure === 'NONE' && polishArt === 'NONE' && acrylic === 'NONE' && gel === 'NONE' && other === 'NONE') {
        estimateMessage.innerHTML = '';
        return;
    }

    let totalDuration = 0;

    // Add durations for selected services
    [manicurePedicure, polishArt, acrylic, gel, other].forEach(service => {
        if (service && service !== 'NONE') {
            totalDuration += serviceDurations[service] || 0;
        }
    });

    // Display estimated time
    if (totalDuration > 0) {
        const hours = Math.floor(totalDuration / 60);
        const minutes = totalDuration % 60;
        let timeStr = '';
        if (hours > 0) timeStr += `${hours} hour${hours > 1 ? 's' : ''}`;
        if (minutes > 0) {
            if (timeStr) timeStr += ' and ';
            timeStr += `${minutes} minute${minutes > 1 ? 's' : ''}`;
        }
        estimateMessage.innerHTML = `Estimated Duration: Approximately ${timeStr}`;
    } else {
        estimateMessage.innerHTML = '';
    }
}


    function normalizeTimeStr(timeStr) {
  if (!timeStr) return null;

  // ✅ Already in AM/PM format
  if (timeStr.includes("AM") || timeStr.includes("PM")) return timeStr;

  // ✅ Convert from 24-hour format (e.g. "13:30" → "1:30 PM")
  let [hours, minutes] = timeStr.split(":").map(Number);
  const period = hours >= 12 ? "PM" : "AM";
  hours = hours % 12 || 12;
  return `${hours}:${minutes.toString().padStart(2, "0")} ${period}`;
}


// Replace your existing validateTimeSlot function with this improved version

function validateTimeSlot(date, selectedTime) {
  const dayName = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long' });
  const business = businessHours[dayName];

  if (!business) {
    alert(`We are closed on Sundays. Please select another day.`);
    return Promise.resolve(false);
  }

  const selectedMinutes = convertToMinutes(selectedTime);
  const openMinutes = convertToMinutes(business.open);
  const closeMinutes = convertToMinutes(business.close);

  if (selectedMinutes < openMinutes || selectedMinutes >= closeMinutes) {
    alert(`Please choose a time within business hours.\n\nBusiness Hours for ${dayName}: ${business.open} to ${business.close}`);
    return Promise.resolve(false);
  }

  return db.collection('unavailableDays').where('date', '==', date).get()
    .then((unavailableSnapshot) => {
      let isUnavailable = false;

      unavailableSnapshot.forEach((doc) => {
        const data = doc.data();

        if (data.allDay) {
          isUnavailable = true;
        } else {
          const startMinutes = convertToMinutes(normalizeTimeStr(data.startTime));
          const endMinutes = convertToMinutes(normalizeTimeStr(data.endTime));

          if (selectedMinutes >= startMinutes && selectedMinutes <= endMinutes) {
            isUnavailable = true;
          }
        }
      });

      if (isUnavailable) {
        return false;
      }

      return db.collection('bookings')
        .where('date', '==', date)
        .get()
        .then((querySnapshot) => {
          // Get the duration of the service being booked
          const newServiceDuration = getSelectedServiceDuration();
          const newServiceEndTime = selectedMinutes + newServiceDuration;

          for (let doc of querySnapshot.docs) {
            let bookedTime = doc.data().time.trim().replace(/\s+/g, ' ');
            let bookedMinutes = convertToMinutes(bookedTime);
            let bookedDuration = doc.data().duration || 60; // Get stored duration or default
            let bookedEndTime = bookedMinutes + bookedDuration;

            // Check for actual time overlap (no buffer needed)
            // New booking conflicts if it starts before existing booking ends 
            // AND existing booking starts before new booking ends
            if (selectedMinutes < bookedEndTime && bookedMinutes < newServiceEndTime) {
              console.log(`Conflict detected: New booking ${selectedTime} conflicts with existing booking at ${bookedTime}`);
              return false;
            }
          }

          return true; // No conflict
        });
    })
    .catch(error => {
      console.error("Error validating time slot:", error);
      return false;
    });
}

// Also update your getBufferForSelectedServices function to be simpler
function getBufferForSelectedServices() {
  // Return a small buffer just for UI purposes (5-10 minutes)
  // The real conflict checking is now done by actual service durations
  return 0; 
}
    

function generateBookingNumber(name) {
  const initials = name.trim().substring(0, 2).toUpperCase();
  const digits = Math.floor(1000 + Math.random() * 9000); // random 4 digits
  return initials + digits;
}


  
function submitBooking(event) {
  event.preventDefault();

  const user = firebase.auth().currentUser;
  if (!user) {
    if (confirm("You must be logged in to book an appointment. Click OK to log in.")) {
      window.location.href = 'login.html';
    }
    return;
  }

  // Get form values
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const date = document.getElementById('date').value;
  const time = document.getElementById('selectedTime').value;
  const services = getSelectedServices();

  // Enhanced validation with detailed logging
  console.log('Form values:', { name, phone, date, time, services });

  if (!name || !phone || !date || !time) {
    alert('Please fill in all required fields.');
    return;
  }

  if (services === 'No services selected') {
    alert('Please select at least one service before booking.');
    return;
  }

  const bookingNumber = generateBookingNumber(name);
  const duration = getSelectedServiceDuration();

  console.log('About to validate time slot...');

  validateTimeSlot(date, time)
    .then((isAvailable) => {
      console.log('Time slot validation result:', isAvailable);
      
      if (!isAvailable) {
        alert('This time is not available. Please choose another time.');
        return Promise.reject('Time slot not available'); // This will skip the rest
      }

      console.log('Adding booking to database...');
      
      // Add booking to database
      return db.collection('bookings').add({
        uid: user.uid,
        bookingNumber,
        name,
        phone,
        date: date,
        time,
        service: services,
        duration,
        deposit: "No",
        timestamp: firebase.firestore.FieldValue.serverTimestamp() // Add timestamp for debugging
      });
    })
    .then((docRef) => {
      if (!docRef) {
        // This means validateTimeSlot returned false and we rejected
        return;
      }
      
      console.log('Booking saved successfully, sending Telegram notification...');
      
      const [year, month, day] = date.split("-");
      const formattedDate = new Date(year, month - 1, day).toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });

      const message = `📅 NEW BOOKING

🔢 Booking #: ${bookingNumber}
👤 Name: ${name}
📞 Phone: ${phone}
📍 Date: ${formattedDate}
⏰ Time: ${time}
💅 Service: ${services}`;

      const telegramBotToken = "8320926833:AAHmcN6foSjjN-7WXYjs_J50J0CDZ0QwFbA";

      const telegramChatId = "8280486738";

      return fetch(`https://api.telegram.org/bot${telegramBotToken}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: telegramChatId,
          text: message,
          parse_mode: "HTML"
        })
      });
    })
    .then((response) => {
      if (!response) {
        // This means we skipped due to unavailable time slot
        return;
      }
      
      console.log('Telegram API response status:', response.status);
      
      // Note: Telegram API might fail but booking should still be considered successful
      if (response.status >= 200 && response.status < 300) {
        console.log('Telegram notification sent successfully');
      } else {
        console.warn('Telegram notification failed, but booking was saved');
      }
      
      // Always show success if we got this far (booking was saved)
      document.querySelector("#bookingSection form").reset();
      document.getElementById("estimateTimeMessage").innerHTML = "";
      document.getElementById("selectedTime").innerHTML = "<option value=''>Pick date & service first</option>";

      document.querySelector("#bookingModal h3").style.display = "none";
      document.querySelector("#bookingModal p").innerHTML = `
        <div style="
  text-align:center; 
  padding:20px; 
  font-family:Arial,sans-serif; 
  color:#333;
  max-width:420px;
  margin:0 auto;
  background:white;
  border-radius:12px;
  box-shadow:0 6px 20px rgba(0,0,0,0.2);">
  
  <!-- Success Icon -->
  <div style="
    width:70px; 
    height:70px; 
    border-radius:50%; 
    background:#28a745; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    margin:0 auto 15px;">
    <span style="font-size:38px; color:white;">✔</span>
  </div>

  <!-- Title -->
  <h2 style="margin:0 0 12px 0; font-size:22px; font-weight:bold;">
    BOOKING CONFIRMED
  </h2>

  <!-- Booking number -->
  <p style="font-size:16px; margin:0 0 12px 0;">
    Your Booking #: <strong>${bookingNumber}</strong>
  </p>

  <hr style="margin:15px 0; border:0; height:1px; background:#ddd;">

  <!-- Message -->
  <p style="font-size:15px; margin:10px 0;">
    Thank you for booking with us! We are looking forward to see you soon. 🎉
  </p>

  <hr style="margin:15px 0; border:0; height:1px; background:#ddd;">

  <!-- Info text -->
  <p style="font-size:13px; color:#555; margin:15px 0; text-align:left; line-height:1.5;">
    ℹ️ If you wish to make your payment via online banking, please click the 
    <b>menu bar</b> icon at the top left of your screen and view the 
    <b>PAYMENT INFO</b> section. Use your booking number as the payment reference.
  </p>

  <!-- OK Button -->
  <button onclick="closeBookingModal()" style="
    margin-top:15px; 
    padding:10px 25px; 
    background:#28a745; 
    color:white; 
    border:none; 
    border-radius:6px; 
    font-size:15px; 
    cursor:pointer;
    font-weight:bold;">
    OK
  </button>
</div>

      `;
      document.getElementById('bookingModal').style.display = 'flex';
    })
    .catch((err) => {
      console.error("Detailed booking error:", err);
      
      // More specific error messages
      if (err === 'Time slot not available') {
        // This error was already handled above
        return;
      } else if (err.code) {
        // Firebase-specific errors
        switch (err.code) {
          case 'permission-denied':
            alert("You don't have permission to make bookings. Please contact support.");
            break;
          case 'unavailable':
            alert("Database is temporarily unavailable. Please try again in a moment.");
            break;
          case 'network-request-failed':
            alert("Network error. Please check your internet connection and try again.");
            break;
          default:
            alert(`Database error: ${err.message}`);
        }
      } else if (err.message && err.message.includes('fetch')) {
        // Network/Telegram API errors - but booking might have been saved
        console.warn("Telegram notification failed, but booking may have been saved");
        alert("Booking may have been saved, but notification failed. Please check 'My Bookings' to confirm.");
      } else {
        // Generic error
        alert("Failed to save booking. Please try again. Error: " + (err.message || err));
      }
    });
}


// The closeBookingModal() function should already exist in your HTML/existing JavaScript
// Add this function to close the modal
function closeBookingModal() {
  document.getElementById('bookingModal').style.display = 'none';
            }

// Add this function to close the modal
function closeBookingModal() {
  document.getElementById('bookingModal').style.display = 'none';
}


    function showSection(sectionId) {
  document.querySelectorAll('.content-section').forEach(section =>
    section.classList.remove('active')
  );
  document.getElementById(sectionId).classList.add('active');

  if (sectionId === 'gallerySection') {
    loadGallery('galleryDisplay');
  } else if (sectionId === 'reviewsSection') {
    loadReviews(currentUser); // ✅ Pass the user here
  }
}

// Assume firebase is initialized and 'db' and 'auth' are set up

let selectedRating = 0;

// Star rating UI logic
document.querySelectorAll('#starRating span').forEach(star => {
  star.addEventListener('click', () => {
    selectedRating = parseInt(star.getAttribute('data-value'));
    document.querySelectorAll('#starRating span').forEach(s => {
      s.style.color = parseInt(s.getAttribute('data-value')) <= selectedRating ? '#f39c12' : '#ccc';
    });
  });
});

// Submit review
document.getElementById('reviewForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const user = firebase.auth().currentUser;
  if (!user) {
    if (confirm("You must be logged in to submit a review. Click OK to log in.")) {
        window.location.href = 'login.html';
    }
    return;
}

  const name = document.getElementById('reviewName').value.trim();
  const comment = document.getElementById('reviewComment').value.trim();
  const msg = document.getElementById('reviewSubmitMsg');

  if (!name || !comment || selectedRating === 0) {
    msg.style.color = "red";
    msg.textContent = "Please fill all fields and select a star rating.";
    return;
  }

  try {
    await db.collection('reviews').add({
      name,
      comment,
      rating: selectedRating,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      uid: user.uid
    });

    msg.style.color = "green";
    msg.textContent = "Thank you for your review!";
    document.getElementById('reviewForm').reset();
    selectedRating = 0;
    document.querySelectorAll('#starRating span').forEach(s => s.style.color = '#ccc');

  } catch (error) {
    console.error("Error submitting review:", error);
    msg.style.color = "red";
    msg.textContent = "Error submitting review.";
  }
});

function formatReviewTime(timestamp) {
  if (!timestamp || !timestamp.toDate) return '';

  const now = new Date();
  const reviewDate = timestamp.toDate();
  const diffMs = now - reviewDate;
  const diffSec = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSec / 60);
  const diffHours = Math.floor(diffMin / 60);
  const diffDays = Math.floor(diffHours / 24);
  const diffWeeks = Math.floor(diffDays / 7);
  const diffMonths = Math.floor(diffDays / 30);
  const diffYears = Math.floor(diffDays / 365);

  if (diffSec < 60) return "Just now";
  if (diffMin < 60) return `${diffMin} minute${diffMin > 1 ? "s" : ""} ago`;
  if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? "s" : ""} ago`;
  if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? "s" : ""} ago`;
  if (diffWeeks < 5) return `${diffWeeks} week${diffWeeks > 1 ? "s" : ""} ago`;
  if (diffMonths < 12) return `${diffMonths} month${diffMonths > 1 ? "s" : ""} ago`;
  return `${diffYears} year${diffYears > 1 ? "s" : ""} ago`;
}


function loadReviews(user) {
  const container = document.getElementById('reviewsContainer');
  container.innerHTML = "<p>Loading reviews...</p>";

  db.collection('reviews').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
    if (snapshot.empty) {
      container.innerHTML = "<p>No reviews yet.</p>";
      return;
    }

    container.innerHTML = '';
    snapshot.forEach(doc => {
      const d = doc.data();
      const isOwner = user && d.uid === user.uid;

      // Format time display
      const dateString = formatReviewTime(d.timestamp);

      // Star rating display
      let stars = '';
      for (let i = 1; i <= 5; i++) {
        stars += `<span style="color: ${i <= d.rating ? '#f39c12' : '#ccc'};">★</span>`;
      }

      container.innerHTML += `
        <div style="background:#fff; border:1px solid #eee; padding:10px; margin-bottom:10px;">
          <div><strong>${d.name}</strong> <small style="color:gray; font-style:italic;">${dateString}</small></div>
          <div>${stars}</div>
          <div>${d.comment}</div>
          ${isOwner ? `<button onclick="deleteReview('${doc.id}')" style="color:red; cursor:pointer;">Delete</button>` : ''}
        </div>
      `;
    });
  });
}


function deleteReview(docId) {
  const user = firebase.auth().currentUser;
if (!user) {
    window.location.href = 'login.html'; // send them to your login form
    return;
}

  db.collection('reviews').doc(docId).get().then(doc => {
    if (!doc.exists) {
      alert("Review not found.");
      return;
    }

    const data = doc.data();
    if (data.uid !== user.uid) {
      alert("You can only delete your own reviews.");
      return;
    }

    // If the review belongs to the current user, delete it
    db.collection('reviews').doc(docId).delete()
      .then(() => alert("Review deleted."))
      .catch(error => alert("Failed to delete review: " + error.message));
  }).catch(error => {
    alert("Error fetching review: " + error.message);
  });
}

    document.addEventListener('DOMContentLoaded', function () {
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      firebase.auth().signOut()
        .then(() => {
          window.location.href = 'login.html';
        })
        .catch((error) => {
          console.error("Logout error:", error);
          alert("Failed to log out.");
        });
    });
  }
});

    function logoutUser() {
  firebase.auth().signOut()
    .then(() => {
      window.location.href = 'login.html'; // or wherever you want after logout
    })
    .catch(error => {
      alert('Logout failed: ' + error.message);
    });
}


    function showUserBookings() {
  const user = firebase.auth().currentUser;
  if (!user) {
    if (confirm("Please log in to view your bookings. Click OK to log in.")) {
      window.location.href = 'login.html';
    }
    return;
  }

  // Close any other modals first
  document.getElementById('bookingModal').style.display = 'none';
  document.getElementById('adminLoginModal').style.display = 'none';

  console.log("Loading bookings for user:", user.uid); // Debug log

  // Show loading state
  document.getElementById('myBookingsContent').innerHTML = '<p style="text-align:center; color:#666;">Loading your bookings...</p>';
  document.getElementById('myBookingsModal').style.display = 'flex';

  // Use onSnapshot for real-time updates when admin changes deposit status
  const unsubscribe = db.collection('bookings')
    .where("uid", "==", user.uid)
    .onSnapshot(snapshot => {
      console.log("Query returned", snapshot.docs.length, "documents"); // Debug log
      
      let bookings = [];
      snapshot.forEach(doc => {
        console.log("Booking data:", doc.data()); // Debug log
        bookings.push({ id: doc.id, ...doc.data() });
      });

      // Sort bookings by date (most recent first)
      bookings.sort((a, b) => {
        let dateA, dateB;
        
        // Handle different date formats
        if (a.date && a.date.toDate) {
          dateA = a.date.toDate();
        } else if (typeof a.date === 'string') {
          dateA = new Date(a.date);
        } else {
          dateA = new Date(0);
        }
        
        if (b.date && b.date.toDate) {
          dateB = b.date.toDate();
        } else if (typeof b.date === 'string') {
          dateB = new Date(b.date);
        } else {
          dateB = new Date(0);
        }
        
        return dateB - dateA;
      });

      // Take only the 5 most recent
      bookings = bookings.slice(0, 5);

      // Build HTML
      let bookingsHTML = "";
      if (bookings.length === 0) {
        bookingsHTML = `
          <div style="text-align:center; padding:20px;">
            <p style="color:#666; font-size:16px;">You don't have any bookings yet.</p>
            <button onclick="closeMyBookings(); showSection('bookingSection');" 
                    style="background-color:#61134A; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; margin-top:10px;">
              Make Your First Booking
            </button>
          </div>
        `;
      } else {
        bookings.forEach(b => {
          // Format date
          let bookingDate = "Unknown Date";
          try {
            if (b.date && b.date.toDate) {
              bookingDate = b.date.toDate().toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric"
              });
            } else if (typeof b.date === "string") {
              const [y, m, d] = b.date.split("-").map(Number);
              if (y && m && d) {
                bookingDate = new Date(y, m - 1, d).toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "long",
                  day: "numeric"
                });
              }
            }
          } catch (err) {
            console.error("Date format issue:", err);
          }

          // Clean services
          let cleanService = "";
          if (b.service) {
            cleanService = b.service
              .replace(/,?\s*Manicure:\s*NONE/gi, "")
              .replace(/,?\s*Pedicure:\s*NONE/gi, "")
              .replace(/,?\s*Nail Extension:\s*NONE/gi, "")
              .trim()
              .replace(/^,+|,+$/g, "") // Remove leading/trailing commas
              .replace(/,\s*,/g, ","); // Remove double commas
          }

          // Build card
          let cardHTML = `
            <div style="
              border:1px solid #ddd;
              border-radius:12px;
              padding:15px;
              margin-bottom:15px;
              background:white;
              box-shadow:0 2px 5px rgba(0,0,0,0.1);
            ">
              <h3 style="margin-top:0; color:#61134A; font-size:18px;">
                Booking #: ${b.bookingNumber || "N/A"}
              </h3>
              <p><strong>👤 Name:</strong> ${b.name || "N/A"}</p>
              <p><strong>📞 Phone:</strong> ${b.phone || "N/A"}</p>
              <p><strong>📅 Date:</strong> ${bookingDate}</p>
              <p><strong>⏰ Time:</strong> ${b.time || "N/A"}</p>
          `;

          if (cleanService) {
            cardHTML += `<p><strong>💅 Services:</strong> ${cleanService}</p>`;
          }

          // Deposit status
          const depositStatus = b.deposit === "Made" || b.deposit === "Yes";
          cardHTML += `
            <p><strong>💵 Payment:</strong> 
              <span style="color:${depositStatus ? 'green' : 'red'}; font-weight:bold;">
                ${depositStatus ? 'Confirmed' : 'Pending'}
              </span>
            </p>
          `;

          if (b.notes) {
            cardHTML += `<p><strong>📝 Notes:</strong> ${b.notes}</p>`;
          }

          cardHTML += `</div>`;
          bookingsHTML += cardHTML;
        });
      }

      // Show in modal
      document.getElementById('myBookingsContent').innerHTML = bookingsHTML;
    }, error => {
      console.error("Error loading bookings:", error);
      document.getElementById('myBookingsContent').innerHTML = `
        <div style="text-align:center; padding:20px;">
          <p style="color:red;">Error loading your bookings.</p>
          <p style="color:#666; font-size:14px;">Please try again or contact support.</p>
          <button onclick="closeMyBookings();" 
                  style="background-color:#ccc; color:#333; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; margin-top:10px;">
            Close
          </button>
        </div>
      `;
    });

  // Store unsubscribe function globally so we can clean it up
  window.bookingsUnsubscribe = unsubscribe;
}

// Make sure the close function exists and cleans up the listener
function closeMyBookings() {
  document.getElementById('myBookingsModal').style.display = 'none';
  
  // Clean up the real-time listener to prevent memory leaks
  if (window.bookingsUnsubscribe) {
    window.bookingsUnsubscribe();
    window.bookingsUnsubscribe = null;
  }
}
    
    
    function showPaymentInfo() {
  Swal.fire({
    title: "<div class='swal2-title-nowrap'>BANK TRANSER INFO</div>",
    html: `
      <div style="text-align:left; font-size:16px; line-height:1.6; color:white;">
        <p><b>Bank Name:</b> NCB</p>
        <p><b>Account Name:</b> Navolene Hamilton</p>
        <p><b>Account Number:</b> 504958825</p>
        <p><b>Branch:</b> Mandeville, Jamaica</p>
        <p><b>Note:</b> Please use your Booking # as the payment reference.</p>
      </div>
    `,
    width: 600,  // ✅ slightly wider modal
    confirmButtonText: "CLOSE",
    background: "#FE5DC7",
    color: "white",
    confirmButtonColor: "#61134A",
    customClass: {
      popup: "swal2-rounded"
    }
  });
    }


// Service duration estimates (in minutes)
const serviceDurations = {
  "Female Manicure": 30,
  "Female Pedicure": 45,
  "Men's Manicure": 30,
  "Men's Pedicure": 60,
  "Gel Polish Fingers": 30,
  "Gel Polish Toes": 30,
  "French Toes": 45,
  "Hand Painted French": 45,
  "Nail Art": 15,
  "XL Full Set": 90,
  "Long Full Set": 45,
  "Medium Full Set": 60,
  "Short Full Set": 60,
  "Oval/Almond Medium": 90,
  "Oval Faded French (Medium)": 60,
  "Coffin": 60,
  "Nail Overlay (Short)": 45,
  "Overlay & Gel Polish": 60,
  "Refill & Gel Polish": 60,
  "Refill My Work (2–3 Weeks)": 45,
  "Reshape & Cutdown Nails": 25,
  "Acrylic All Toes": 60,
  "Acrylic Big Toes": 35,
  "Fix Acrylic Toes": 45,
  "Refill Toes": 25,
  "Gel X (Long)": 75,
  "Gel X (Medium)": 75,
  "Rebalanced Structured Gel": 60,
  "Soak Off Acrylic Fingers & Clean Up": 30,
  "Soak Off Toes": 15,
  "Gem Application": 10,
  "Hair Brush": 10
};


function getBufferForSelectedServices() {
  let buffer = 30; // default buffer in minutes

  // Get the actual form values from your booking form
  const manicurePedicure = document.getElementById('manicurePedicureType')?.value || "NONE";
  const acrylic = document.getElementById('acrylicType')?.value || "NONE";
  const gel = document.getElementById('gelType')?.value || "NONE";

  // Adjust buffer based on service complexity
  if (acrylic !== "NONE" && acrylic.includes("XL")) buffer = 60;
  else if (acrylic !== "NONE" && acrylic.includes("Long")) buffer = 50;
  else if (gel !== "NONE") buffer = 45;
  else if (manicurePedicure !== "NONE" && manicurePedicure.includes("Men's Pedicure")) buffer = 40;

  return buffer;
}

function getSelectedServiceDuration() {
  const manicurePedicure = document.getElementById('manicurePedicureType').value;
  const polishArt = document.getElementById('polishArtType').value;
  const acrylic = document.getElementById('acrylicType').value;
  const gel = document.getElementById('gelType').value;
  const other = document.getElementById('otherType').value;
  
  let totalDuration = 0;
  
  [manicurePedicure, polishArt, acrylic, gel, other].forEach(service => {
    if (service && service !== 'NONE') {
      totalDuration += serviceDurations[service] || 0;
    }
  });
  
  return totalDuration || 60; // fallback to 60 minutes if nothing selected
}

// ✅ FINAL version — only one loadAvailableSlots() now
async function loadAvailableSlots() {
  const date = document.getElementById('date').value;
  
  // Get services from the actual form fields that exist
  const manicurePedicure = document.getElementById('manicurePedicureType')?.value || "NONE";
  const polishArt = document.getElementById('polishArtType')?.value || "NONE";
  const acrylic = document.getElementById('acrylicType')?.value || "NONE";
  const gel = document.getElementById('gelType')?.value || "NONE";
  const other = document.getElementById('otherType')?.value || "NONE";

  const timeSelect = document.getElementById('selectedTime');
  timeSelect.innerHTML = "<option value=''>-- Select a time --</option>";

  // Must have a date + at least one service
  const hasService = [manicurePedicure, polishArt, acrylic, gel, other].some(service => service !== "NONE");
  
  if (!date || !hasService) {
    timeSelect.innerHTML = "<option value=''>COMPLETE FORM TO SEE AVAILABLE SLOTS</option>";
    return;
  }

  const duration = getSelectedServiceDuration();

  const dayName = new Date(date + "T00:00:00").toLocaleDateString('en-US', { weekday: 'long' });
  const business = businessHours[dayName];
  if (!business) {
    timeSelect.innerHTML = "<option value=''>Closed this day</option>";
    return;
  }

  const openMinutes = convertToMinutes(business.open);
  const closeMinutes = convertToMinutes(business.close);

  try {
    // Fetch bookings
    const snapshot = await db.collection("bookings")
      .where("date", "==", date)
      .get();

    const bookings = snapshot.docs.map(doc => {
      const bookedTime = convertToMinutes(normalizeTimeStr(doc.data().time));
      const bookedDuration = doc.data().duration || 60;
      return { start: bookedTime, end: bookedTime + bookedDuration };
    });

    // Fetch unavailable ranges
    const unavailableSnapshot = await db.collection("unavailableDays")
      .where("date", "==", date)
      .get();

    let unavailableRanges = [];
    unavailableSnapshot.forEach(doc => {
      const data = doc.data();

      if (data.allDay) {
        unavailableRanges.push({ start: openMinutes, end: closeMinutes });
      } else {
        const start = convertToMinutes(normalizeTimeStr(data.startTime));
        const end = convertToMinutes(normalizeTimeStr(data.endTime));

        if (!isNaN(start) && !isNaN(end) && end > start) {
          unavailableRanges.push({ start, end });
        }
      }
    });

    // ✅ Allow bookings up to closing time (even if they run over)
    for (let t = openMinutes; t <= closeMinutes; t += 5) {
      const end = t + duration;

      // Block past times for today
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const selectedDate = new Date(date + "T00:00:00");
      if (selectedDate.getTime() === today.getTime()) {
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        if (t <= currentMinutes) {
          continue; // skip this slot
        }
      }

      // Skip if overlaps with any booking or unavailable range
      let conflict =
        bookings.some(b => !(end <= b.start || t >= b.end)) ||
        unavailableRanges.some(r => !(end <= r.start || t >= r.end));

      if (!conflict) {
        const hours = Math.floor(t / 60);
        const minutes = t % 60;
        const ampm = hours >= 12 ? "PM" : "AM";
        const displayHours = ((hours + 11) % 12 + 1);
        const displayTime = `${displayHours}:${minutes.toString().padStart(2, "0")} ${ampm}`;

        let option = document.createElement("option");
        option.value = displayTime;
        option.textContent = displayTime;
        timeSelect.appendChild(option);
      }
    }

    // If no slots remain
    if (timeSelect.options.length === 1) {
      let option = document.createElement("option");
      option.value = "";
      option.textContent = "No available slots";
      timeSelect.appendChild(option);
    }
  } catch (err) {
    console.error("Error loading slots:", err);
    timeSelect.innerHTML = "<option value=''>Error loading slots</option>";
  }
}


// Auto-format phone number in booking form
document.addEventListener("DOMContentLoaded", function () {
  const phoneInput = document.getElementById("phone");
  if (phoneInput) {
    phoneInput.addEventListener("input", function(e) {
      let input = e.target.value.replace(/\D/g, ""); // only digits
      if (input.length > 10) input = input.substring(0, 10); // max 10 digits

      let formatted = input;

      if (input.length > 6) {
        formatted = `(${input.substring(0,3)}) ${input.substring(3,6)}-${input.substring(6)}`;
      } else if (input.length > 3) {
        formatted = `(${input.substring(0,3)}) ${input.substring(3)}`;
      } else if (input.length > 0) {
        formatted = `(${input}`;
      }

      e.target.value = formatted;
    });
  }
});

// Set minimum date to today
document.addEventListener("DOMContentLoaded", function () {
  const dateInput = document.getElementById("date");
  if (dateInput) {
    const today = new Date().toISOString().split("T")[0]; 
    dateInput.setAttribute("min", today);
  }
});

// Get selected services for booking - FIXED to match actual form fields
function getSelectedServices() {
  const manicurePedicure = document.getElementById('manicurePedicureType')?.value || "NONE";
  const polishArt = document.getElementById('polishArtType')?.value || "NONE";
  const acrylic = document.getElementById('acrylicType')?.value || "NONE";
  const gel = document.getElementById('gelType')?.value || "NONE";
  const other = document.getElementById('otherType')?.value || "NONE";
  
  let services = [];
  
  [manicurePedicure, polishArt, acrylic, gel, other].forEach(service => {
    if (service && service !== 'NONE') {
      services.push(service);
    }
  });
  
  return services.length > 0 ? services.join(', ') : 'No services selected';
}


  

// Enhanced Chatbot Configuration - EASILY CUSTOMIZABLE FOR OTHER BUSINESSES
const CHATBOT_CONFIG = {
  businessName: "NAILUXE NAILZ BY NAVIA",
  location: "Shop #4, 1 Wesley road cheago plaza, Angellace beauty salon, Mandeville, Jamaica",
  phone: "876-342-2293",
  openingHours: {
    Monday: "9:00 AM - 6:00 PM",
    Tuesday: "Closed",
    Wednesday: "9:00 AM - 6:00 PM", 
    Thursday: "9:00 AM - 6:00 PM",
    Friday: "9:00 AM - 6:00 PM",
    Saturday: "9:00 AM - 6:00 PM",
    Sunday: "Closed"
  },
  socialMedia: {
    instagram: "@nailz_by_navia",
    tiktok: "@nailzbynavia"
  },
  policies: {
    reschedule: "You can reschedule appointments, but not later than 24 hours before your scheduled time.",
    discounts: "We don't currently offer discounts for recurring clients.",
    inspoImages: "You can't send inspiration images through this chat, but please bring your inspo picture with you to show upon arrival."
  },
  services: {
    "Manicure & Pedicure": [
      { name: "Female Manicure", price: "$2,000+", duration: "30 minutes" },
      { name: "Female Pedicure", price: "$3,000", duration: "45 minutes" },
      { name: "Men's Manicure", price: "$2,000", duration: "30 minutes" },
      { name: "Men's Pedicure", price: "$5,000", duration: "60 minutes" }
    ],
    "Polish & Art": [
      { name: "Gel Polish Fingers", price: "$3,000", duration: "30 minutes" },
      { name: "Gel Polish Toes", price: "$2,000+", duration: "30 minutes" },
      { name: "French Toes", price: "$2,500+", duration: "45 minutes" },
      { name: "Hand Painted French", price: "$2,000+", duration: "45 minutes" },
      { name: "Nail Art", price: "$300+", duration: "15 minutes" }
    ],
    "Acrylic Services": [
      { name: "XL Full Set", price: "$8,000+", duration: "90 minutes" },
      { name: "Long Full Set", price: "$7,000+", duration: "45 minutes" },
      { name: "Medium Full Set", price: "$6,000+", duration: "60 minutes" },
      { name: "Short Full Set", price: "$5,000+", duration: "60 minutes" },
      { name: "Coffin", price: "$6,000+", duration: "60 minutes" },
      { name: "Nail Overlay (Short)", price: "$4,500+", duration: "45 minutes" }
    ],
    "Gel Services": [
      { name: "Gel X (Long)", price: "$7,500+", duration: "75 minutes" },
      { name: "Gel X (Medium)", price: "$6,500+", duration: "75 minutes" },
      { name: "Rebalanced Structured Gel", price: "$5,500+", duration: "60 minutes" }
    ]
  }
};

// ============================================
// ADVANCED AI SEARCH ENGINE WITH REASONING
// ============================================

class AdvancedAISearchEngine {
  constructor() {
    this.knowledgeBase = [];
    this.vectorIndex = new Map();
    this.vocabulary = new Set();
    this.idfScores = new Map();
    this.wordEmbeddings = new Map();
    this.conceptGraph = new Map();
    this.reasoningChains = new Map();
    this.queryCache = new Map();
    this.initialized = false;
    
    this.init();
  }

  // Initialize the AI with enhanced reasoning capabilities
  init() {
    this.buildAdvancedKnowledgeBase();
    this.buildConceptualMappings();
    this.buildVocabulary();
    this.calculateAdvancedScores();
    this.vectorizeKnowledge();
    this.buildReasoningChains();
    this.initialized = true;
    console.log('Advanced AI Search Engine initialized with', this.knowledgeBase.length, 'knowledge entries');
  }

  // Build comprehensive knowledge base with semantic relationships
  buildAdvancedKnowledgeBase() {
    const kb = [];
    
    // Enhanced services with contextual information
    Object.entries(CHATBOT_CONFIG.services).forEach(([category, services]) => {
      services.forEach(service => {
        // Extract price range for reasoning
        const priceMatch = service.price.match(/\$(\d{1,3}(?:,\d{3})*)/g);
        const basePrice = priceMatch ? parseInt(priceMatch[0].replace(/[$,]/g, '')) : 0;
        const isVariable = service.price.includes('+');
        
        // Extract duration in minutes
        const durationMatch = service.duration.match(/(\d+)/);
        const durationMinutes = durationMatch ? parseInt(durationMatch[0]) : 30;
        
        // Determine complexity and luxury level
        const complexity = this.assessServiceComplexity(service.name, category, durationMinutes, basePrice);
        const luxuryLevel = this.assessLuxuryLevel(basePrice, service.name);
        
        kb.push({
          id: `service_${service.name.toLowerCase().replace(/\s+/g, '_')}`,
          type: 'service',
          category: category,
          title: service.name,
          content: `${service.name} is a ${category.toLowerCase()} service offered at ${CHATBOT_CONFIG.businessName}. It costs ${service.price} and takes ${service.duration} to complete. This ${complexity} service provides ${luxuryLevel} nail care with professional results.`,
          metadata: {
            price: service.price,
            basePrice: basePrice,
            isVariablePrice: isVariable,
            duration: service.duration,
            durationMinutes: durationMinutes,
            category: category,
            complexity: complexity,
            luxuryLevel: luxuryLevel,
            recommendedFor: this.getRecommendations(service.name, category)
          },
          semanticTags: this.generateSemanticTags(service.name, category),
          keywords: [
            ...service.name.toLowerCase().split(' '),
            ...category.toLowerCase().split(' '),
            'nail', 'beauty', 'salon', 'professional', complexity, luxuryLevel
          ]
        });
      });
    });

    // Enhanced business information with reasoning context
    kb.push({
      id: 'business_hours',
      type: 'hours',
      title: 'Opening Hours & Availability',
      content: `${CHATBOT_CONFIG.businessName} operates Monday and Wednesday through Saturday from 9:00 AM to 6:00 PM (9 hours daily). We are closed on Tuesdays and Sundays for rest and preparation. Our peak hours are typically Friday and Saturday.`,
      metadata: {
        ...CHATBOT_CONFIG.openingHours,
        totalWeeklyHours: 45,
        peakDays: ['Friday', 'Saturday'],
        closedDays: ['Tuesday', 'Sunday'],
        dailyHours: 9
      },
      semanticTags: ['availability', 'schedule', 'timing', 'business_operations'],
      keywords: ['hours', 'open', 'close', 'time', 'schedule', 'available', 'when', 'monday', 'wednesday', 'thursday', 'friday', 'saturday']
    });

    kb.push({
      id: 'business_location',
      type: 'location',
      title: 'Location & Accessibility',
      content: `${CHATBOT_CONFIG.businessName} is conveniently located at ${CHATBOT_CONFIG.location}. We're inside Angellace beauty salon in the Cheago Plaza on Wesley Road, making us easily accessible in Mandeville. Contact us at ${CHATBOT_CONFIG.phone} for directions or appointments.`,
      metadata: {
        address: CHATBOT_CONFIG.location,
        phone: CHATBOT_CONFIG.phone,
        city: 'Mandeville',
        country: 'Jamaica',
        plaza: 'Cheago Plaza',
        street: 'Wesley Road',
        shopNumber: '4',
        insideLocation: 'Angellace beauty salon'
      },
      semanticTags: ['location', 'accessibility', 'directions', 'contact'],
      keywords: ['location', 'address', 'where', 'find', 'contact', 'phone', 'call', 'mandeville', 'jamaica', 'wesley', 'road', 'cheago', 'plaza', 'angellace']
    });

    // Enhanced policies with reasoning context
    Object.entries(CHATBOT_CONFIG.policies).forEach(([key, policy]) => {
      const reasoning = this.getPolicyReasoning(key, policy);
      kb.push({
        id: `policy_${key}`,
        type: 'policy',
        title: key.charAt(0).toUpperCase() + key.slice(1) + ' Policy',
        content: `${policy} ${reasoning}`,
        metadata: { 
          policyType: key,
          reasoning: reasoning,
          strictness: this.assessPolicyStrictness(policy)
        },
        semanticTags: ['policy', 'rules', 'guidelines', key],
        keywords: [key, 'policy', 'rule', 'guideline', 'requirement']
      });
    });

    // Enhanced social media with engagement context
    kb.push({
      id: 'social_media',
      type: 'social',
      title: 'Social Media & Inspiration',
      content: `Stay connected with ${CHATBOT_CONFIG.businessName} on Instagram ${CHATBOT_CONFIG.socialMedia.instagram} and TikTok ${CHATBOT_CONFIG.socialMedia.tiktok}. Follow us for daily nail art inspiration, behind-the-scenes content, client showcases, and the latest trends in nail design.`,
      metadata: {
        ...CHATBOT_CONFIG.socialMedia,
        platforms: ['Instagram', 'TikTok'],
        contentTypes: ['inspiration', 'tutorials', 'showcases', 'trends']
      },
      semanticTags: ['social_media', 'inspiration', 'trends', 'community'],
      keywords: ['social', 'instagram', 'tiktok', 'follow', 'inspiration', 'updates', 'trends', 'designs']
    });

    // Enhanced booking with process reasoning
    kb.push({
      id: 'booking_process',
      type: 'booking',
      title: 'Appointment Booking Process',
      content: 'To book an appointment: 1) Visit our website, 2) Click the menu button and select "Booking", 3) Create an account or log in, 4) Choose your desired services, 5) Select available date and time, 6) Confirm your appointment. Account creation helps us track your preferences and appointment history.',
      metadata: { 
        process: 'booking',
        steps: 6,
        requiresAccount: true,
        reasoning: 'Account system enables personalized service and appointment tracking'
      },
      semanticTags: ['booking', 'appointment', 'process', 'website'],
      keywords: ['book', 'appointment', 'schedule', 'reserve', 'booking', 'account', 'website', 'online']
    });

    // Add comparative analysis entries
    kb.push({
      id: 'service_comparison',
      type: 'comparison',
      title: 'Service Comparison Guide',
      content: 'Our services range from quick 15-minute nail art ($300+) to comprehensive 90-minute XL Full Sets ($8,000+). Gel services offer durability, acrylics provide length and strength, while basic manicures focus on nail health and maintenance.',
      metadata: {
        priceRange: { min: 300, max: 8000 },
        timeRange: { min: 15, max: 90 },
        categories: Object.keys(CHATBOT_CONFIG.services)
      },
      semanticTags: ['comparison', 'options', 'recommendations'],
      keywords: ['compare', 'difference', 'best', 'recommend', 'choice', 'option']
    });

    this.knowledgeBase = kb;
  }

  // Generate semantic tags for enhanced understanding
  generateSemanticTags(serviceName, category) {
    const tags = [];
    const name = serviceName.toLowerCase();
    const cat = category.toLowerCase();
    
    // Service type tags
    if (name.includes('manicure') || cat.includes('manicure')) tags.push('hand_care', 'nail_maintenance');
    if (name.includes('pedicure') || cat.includes('pedicure')) tags.push('foot_care', 'nail_maintenance');
    if (name.includes('gel')) tags.push('durability', 'long_lasting', 'glossy_finish');
    if (name.includes('acrylic')) tags.push('length_enhancement', 'strength', 'artificial_nails');
    if (name.includes('french')) tags.push('classic_style', 'elegant', 'timeless');
    if (name.includes('art')) tags.push('creative', 'decorative', 'personalized');
    if (name.includes('xl') || name.includes('long')) tags.push('dramatic', 'statement');
    if (name.includes('short') || name.includes('overlay')) tags.push('natural_looking', 'conservative');
    
    // Occasion tags
    if (name.includes('french') || name.includes('classic')) tags.push('professional', 'wedding_appropriate');
    if (name.includes('art') || name.includes('design')) tags.push('creative', 'social_media_worthy');
    
    return tags;
  }

  // Assess service complexity for reasoning
  assessServiceComplexity(name, category, duration, price) {
    const complexityScore = (duration * 0.1) + (price * 0.0001);
    if (complexityScore > 10 || name.includes('XL') || name.includes('Art')) return 'advanced';
    if (complexityScore > 5 || duration > 45) return 'intermediate';
    return 'basic';
  }

  // Assess luxury level for positioning
  assessLuxuryLevel(price, name) {
    if (price >= 7000 || name.includes('XL')) return 'premium';
    if (price >= 4000) return 'mid-range';
    return 'affordable';
  }

  // Get service recommendations based on analysis
  getRecommendations(serviceName, category) {
    const name = serviceName.toLowerCase();
    const recommendations = [];
    
    if (name.includes('manicure') && !name.includes('men')) {
      recommendations.push('perfect for regular maintenance', 'ideal before special events');
    }
    if (name.includes('pedicure')) {
      recommendations.push('great for sandal season', 'relaxing self-care');
    }
    if (name.includes('acrylic')) {
      recommendations.push('ideal for length and strength', 'perfect for special occasions');
    }
    if (name.includes('gel')) {
      recommendations.push('long-lasting results', 'chip-resistant finish');
    }
    if (name.includes('french')) {
      recommendations.push('timeless elegance', 'professional appearance');
    }
    
    return recommendations;
  }

  // Build conceptual mappings for advanced reasoning
  buildConceptualMappings() {
    this.conceptGraph.set('price_related', ['cost', 'expensive', 'cheap', 'affordable', 'budget', 'fee', 'charge', 'money']);
    this.conceptGraph.set('time_related', ['duration', 'long', 'quick', 'fast', 'slow', 'minutes', 'hours']);
    this.conceptGraph.set('quality_related', ['professional', 'premium', 'luxury', 'basic', 'advanced', 'expert']);
    this.conceptGraph.set('location_related', ['where', 'address', 'directions', 'find', 'located', 'situated']);
    this.conceptGraph.set('availability_related', ['open', 'closed', 'hours', 'schedule', 'available', 'appointment']);
    this.conceptGraph.set('service_related', ['nail', 'manicure', 'pedicure', 'polish', 'art', 'design']);
    this.conceptGraph.set('comparison_related', ['best', 'better', 'compare', 'difference', 'recommend', 'suggest']);
  }

  // Enhanced vocabulary building with semantic relationships
  buildVocabulary() {
    this.knowledgeBase.forEach(item => {
      const words = this.tokenize(item.content + ' ' + item.keywords.join(' ') + ' ' + item.semanticTags.join(' '));
      words.forEach(word => {
        this.vocabulary.add(word);
        // Build simple word embeddings based on co-occurrence
        this.buildWordEmbeddings(word, words);
      });
    });
  }

  // Build simple word embeddings for semantic understanding
  buildWordEmbeddings(word, context) {
    if (!this.wordEmbeddings.has(word)) {
      this.wordEmbeddings.set(word, new Map());
    }
    
    const embedding = this.wordEmbeddings.get(word);
    context.forEach(contextWord => {
      if (contextWord !== word) {
        embedding.set(contextWord, (embedding.get(contextWord) || 0) + 1);
      }
    });
  }

  // Calculate advanced scoring metrics
  calculateAdvancedScores() {
    this.calculateIDF();
    this.calculateSemanticSimilarities();
  }

  // Calculate IDF scores
  calculateIDF() {
    const docCount = this.knowledgeBase.length;
    
    this.vocabulary.forEach(word => {
      const docsWithWord = this.knowledgeBase.filter(item => {
        const text = item.content + ' ' + item.keywords.join(' ') + ' ' + item.semanticTags.join(' ');
        return this.tokenize(text).includes(word);
      }).length;
      
      this.idfScores.set(word, Math.log(docCount / (docsWithWord + 1)));
    });
  }

  // Calculate semantic similarities between words
  calculateSemanticSimilarities() {
    // This would be expanded in a full implementation
    // For now, we use conceptual mappings for semantic understanding
  }

  // Build reasoning chains for complex queries
  buildReasoningChains() {
    // Price comparison reasoning
    this.reasoningChains.set('price_comparison', (query, results) => {
      const services = results.filter(r => r.type === 'service');
      if (services.length > 1) {
        services.sort((a, b) => a.metadata.basePrice - b.metadata.basePrice);
        return this.generatePriceComparisonReasoning(services);
      }
      return null;
    });

    // Time-based reasoning
    this.reasoningChains.set('duration_optimization', (query, results) => {
      const services = results.filter(r => r.type === 'service');
      const timeQuery = query.match(/(quick|fast|short|long|time)/i);
      if (timeQuery && services.length > 0) {
        return this.generateTimeBasedReasoning(services, timeQuery[0].toLowerCase());
      }
      return null;
    });

    // Recommendation reasoning
    this.reasoningChains.set('service_recommendation', (query, results) => {
      const intentKeywords = ['best', 'recommend', 'suggest', 'good for', 'should i'];
      const hasRecommendationIntent = intentKeywords.some(keyword => query.toLowerCase().includes(keyword));
      
      if (hasRecommendationIntent) {
        return this.generateRecommendationReasoning(query, results);
      }
      return null;
    });
  }

  // Generate price comparison reasoning
  generatePriceComparisonReasoning(services) {
    const cheapest = services[0];
    const mostExpensive = services[services.length - 1];
    
    return `Based on pricing analysis: ${cheapest.title} is our most affordable option at ${cheapest.metadata.price}, while ${mostExpensive.title} is our premium service at ${mostExpensive.metadata.price}. The price difference reflects the complexity, duration, and materials involved.`;
  }

  // Generate time-based reasoning
  generateTimeBasedReasoning(services, timePreference) {
    if (timePreference === 'quick' || timePreference === 'fast' || timePreference === 'short') {
      const quickServices = services.filter(s => s.metadata.durationMinutes <= 30);
      if (quickServices.length > 0) {
        const quickest = quickServices.sort((a, b) => a.metadata.durationMinutes - b.metadata.durationMinutes)[0];
        return `For quick service, I recommend ${quickest.title} which takes only ${quickest.metadata.duration}. This is perfect when you're short on time but want professional results.`;
      }
    } else if (timePreference === 'long') {
      const luxuryServices = services.filter(s => s.metadata.durationMinutes >= 60);
      if (luxuryServices.length > 0) {
        const longest = luxuryServices.sort((a, b) => b.metadata.durationMinutes - a.metadata.durationMinutes)[0];
        return `For a comprehensive experience, ${longest.title} provides ${longest.metadata.duration} of detailed attention, perfect for a luxury pampering session.`;
      }
    }
    return null;
  }

  // Generate recommendation reasoning
  generateRecommendationReasoning(query, results) {
    const queryLower = query.toLowerCase();
    let recommendations = [];
    
    // Analyze query for specific needs
    if (queryLower.includes('special') || queryLower.includes('event') || queryLower.includes('wedding')) {
      const elegant = results.filter(r => r.semanticTags && r.semanticTags.includes('elegant'));
      if (elegant.length > 0) {
        recommendations.push(`For special events, I highly recommend ${elegant[0].title} - it's ${elegant[0].metadata.luxuryLevel} and provides an elegant, lasting finish.`);
      }
    }
    
    if (queryLower.includes('first time') || queryLower.includes('beginner')) {
      const basic = results.filter(r => r.metadata.complexity === 'basic');
      if (basic.length > 0) {
        recommendations.push(`For first-time clients, ${basic[0].title} is perfect. It's ${basic[0].metadata.complexity} and gives you a feel for our quality work.`);
      }
    }
    
    if (queryLower.includes('durable') || queryLower.includes('long lasting')) {
      const durable = results.filter(r => r.semanticTags && r.semanticTags.includes('long_lasting'));
      if (durable.length > 0) {
        recommendations.push(`For durability, ${durable[0].title} is excellent. It's designed to last longer than regular polish.`);
      }
    }
    
    return recommendations.length > 0 ? recommendations.join(' ') : null;
  }

  // Advanced tokenization with stemming and normalization
  tokenize(text) {
    return text.toLowerCase()
      .replace(/[^\w\s]/g, ' ')
      .split(/\s+/)
      .filter(word => word.length > 2)
      .filter(word => !this.isStopWord(word))
      .map(word => this.stemWord(word));
  }

  // Simple stemming for better matching
  stemWord(word) {
    const stemRules = {
      'ing': '', 'tion': 't', 'ness': '', 'ment': '', 
      'able': '', 'ible': '', 'ally': '', 'ity': ''
    };
    
    for (const [suffix, replacement] of Object.entries(stemRules)) {
      if (word.endsWith(suffix) && word.length > suffix.length + 2) {
        return word.slice(0, -suffix.length) + replacement;
      }
    }
    return word;
  }

  // Enhanced stop words filter
  isStopWord(word) {
    const stopWords = new Set([
      'the', 'and', 'for', 'are', 'but', 'not', 'you', 'all', 'can', 'had', 
      'her', 'was', 'one', 'our', 'out', 'day', 'get', 'has', 'him', 'his', 
      'how', 'its', 'may', 'new', 'now', 'old', 'see', 'two', 'who', 'boy', 
      'did', 'she', 'use', 'way', 'what', 'will', 'with', 'have', 'this',
      'that', 'from', 'they', 'know', 'want', 'been', 'good', 'much', 'some',
      'time', 'very', 'when', 'come', 'here', 'just', 'like', 'long', 'make',
      'many', 'over', 'such', 'take', 'than', 'them', 'well', 'were'
    ]);
    return stopWords.has(word);
  }

  // Vectorize knowledge with enhanced TF-IDF
  vectorizeKnowledge() {
    this.knowledgeBase.forEach(item => {
      const text = item.content + ' ' + item.keywords.join(' ') + ' ' + item.semanticTags.join(' ');
      const vector = this.textToEnhancedVector(text);
      this.vectorIndex.set(item.id, vector);
    });
  }

  // Enhanced vectorization with semantic weighting
  textToEnhancedVector(text) {
    const words = this.tokenize(text);
    const termFreq = new Map();
    const vector = new Map();

    // Calculate term frequency with semantic boost
    words.forEach(word => {
      let boost = 1;
      
      // Boost important semantic concepts
      for (const [concept, relatedWords] of this.conceptGraph.entries()) {
        if (relatedWords.includes(word)) {
          boost = 1.5;
          break;
        }
      }
      
      termFreq.set(word, (termFreq.get(word) || 0) + boost);
    });

    // Calculate enhanced TF-IDF with semantic weighting
    termFreq.forEach((tf, word) => {
      const idf = this.idfScores.get(word) || 0;
      const semanticWeight = this.getSemanticWeight(word);
      vector.set(word, tf * idf * semanticWeight);
    });

    return vector;
  }

  // Get semantic weight for word based on business context
  getSemanticWeight(word) {
    const businessKeywords = ['nail', 'manicure', 'pedicure', 'service', 'price', 'booking'];
    if (businessKeywords.includes(word)) return 1.5;
    
    const locationKeywords = ['mandeville', 'jamaica', 'wesley', 'cheago'];
    if (locationKeywords.includes(word)) return 1.3;
    
    return 1.0;
  }

  // Enhanced cosine similarity with semantic boosting
  cosineSimilarity(vec1, vec2) {
    let dotProduct = 0;
    let norm1 = 0;
    let norm2 = 0;

    const allWords = new Set([...vec1.keys(), ...vec2.keys()]);

    allWords.forEach(word => {
      const v1 = vec1.get(word) || 0;
      const v2 = vec2.get(word) || 0;
      
      // Apply semantic similarity boost
      const semanticBoost = this.getSemanticSimilarityBoost(word, allWords);
      
      dotProduct += v1 * v2 * semanticBoost;
      norm1 += v1 * v1;
      norm2 += v2 * v2;
    });

    if (norm1 === 0 || norm2 === 0) return 0;
    return dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2));
  }

  // Get semantic similarity boost between words
  getSemanticSimilarityBoost(word, contextWords) {
    let boost = 1.0;
    
    // Check if word has semantic relationships with context
    const wordEmbedding = this.wordEmbeddings.get(word);
    if (wordEmbedding) {
      let relationshipStrength = 0;
      contextWords.forEach(contextWord => {
        if (wordEmbedding.has(contextWord)) {
          relationshipStrength += wordEmbedding.get(contextWord);
        }
      });
      
      if (relationshipStrength > 2) {
        boost = 1.2;
      }
    }
    
    return boost;
  }

  // Advanced semantic search with reasoning
  semanticSearch(query, limit = 5) {
    // Check cache first for performance
    const cacheKey = query.toLowerCase().trim();
    if (this.queryCache.has(cacheKey)) {
      console.log('Cache hit for query:', query);
      return this.queryCache.get(cacheKey);
    }

    if (!this.initialized) {
      console.warn('AI not initialized yet');
      return [];
    }

    const queryVector = this.textToEnhancedVector(query);
    const results = [];

    this.knowledgeBase.forEach(item => {
      const itemVector = this.vectorIndex.get(item.id);
      let similarity = this.cosineSimilarity(queryVector, itemVector);
      
      // Apply contextual boosting
      similarity = this.applyContextualBoosting(query, item, similarity);
      
      if (similarity > 0.05) { // Lower threshold for better recall
        results.push({
          ...item,
          similarity: similarity,
          relevanceScore: this.calculateAdvancedRelevanceScore(query, item, similarity)
        });
      }
    });

    const finalResults = results
      .sort((a, b) => b.relevanceScore - a.relevanceScore)
      .slice(0, limit);

    // Cache results
    this.queryCache.set(cacheKey, finalResults);
    
    // Clear cache if it gets too large
    if (this.queryCache.size > 100) {
      const oldestKey = this.queryCache.keys().next().value;
      this.queryCache.delete(oldestKey);
    }

    return finalResults;
  }

  // Apply contextual boosting based on query patterns
  applyContextualBoosting(query, item, baseSimilarity) {
    let boostedSimilarity = baseSimilarity;
    const queryLower = query.toLowerCase();
    
    // Boost exact matches
    const titleWords = this.tokenize(item.title);
    const queryWords = this.tokenize(query);
    const exactMatches = queryWords.filter(word => titleWords.includes(word)).length;
    
    if (exactMatches > 0) {
      boostedSimilarity *= (1 + exactMatches * 0.3);
    }
    
    // Intent-based boosting
    if (queryLower.includes('price') || queryLower.includes('cost')) {
      if (item.type === 'service' || item.id === 'service_comparison') {
        boostedSimilarity *= 1.4;
      }
    }
    
    if (queryLower.includes('hour') || queryLower.includes('open') || queryLower.includes('when')) {
      if (item.type === 'hours') boostedSimilarity *= 1.8;
    }
    
    if (queryLower.includes('where') || queryLower.includes('location') || queryLower.includes('address')) {
      if (item.type === 'location') boostedSimilarity *= 1.8;
    }
    
    if (queryLower.includes('book') || queryLower.includes('appointment') || queryLower.includes('schedule')) {
      if (item.type === 'booking') boostedSimilarity *= 1.6;
    }
    
    if (queryLower.includes('best') || queryLower.includes('recommend') || queryLower.includes('compare')) {
      if (item.type === 'comparison' || item.type === 'service') boostedSimilarity *= 1.3;
    }
    
    return boostedSimilarity;
  }

  // Calculate advanced relevance score with multiple factors
  calculateAdvancedRelevanceScore(query, item, similarity) {
    let score = similarity * 100;
    const queryLower = query.toLowerCase();
    const queryWords = this.tokenize(query);
    
    // Exact keyword matching bonus
    const keywordMatches = queryWords.filter(word => 
      item.keywords.some(keyword => keyword.includes(word)) || 
      item.title.toLowerCase().includes(word)
    ).length;
    score += keywordMatches * 15;
    
    // Semantic tag matching bonus
    const semanticMatches = queryWords.filter(word => 
      item.semanticTags && item.semanticTags.some(tag => tag.includes(word))
    ).length;
    score += semanticMatches * 12;
    
    // Business context boost
    const businessTerms = ['nail', 'service', 'salon', 'beauty'];
    const businessMatches = queryWords.filter(word => businessTerms.includes(word)).length;
    score += businessMatches * 8;
    
    // Recency and relevance factors
    if (item.type === 'service') {
      score += 5; // Services are generally more important
      
      // Boost popular services
      const popularServices = ['manicure', 'pedicure', 'gel', 'acrylic'];
      if (popularServices.some(service => item.title.toLowerCase().includes(service))) {
        score += 3;
      }
    }
    
    // Question type analysis
    if (queryLower.startsWith('what') || queryLower.startsWith('how') || queryLower.startsWith('when') || queryLower.startsWith('where')) {
      if (item.type === 'hours' && queryLower.includes('when')) score *= 1.2;
      if (item.type === 'location' && queryLower.includes('where')) score *= 1.2;
      if (item.type === 'booking' && queryLower.includes('how')) score *= 1.2;
    }
    
    return score;
  }

  // Generate intelligent response with advanced reasoning
  generateIntelligentResponse(query, searchResults) {
    if (searchResults.length === 0) {
      return null;
    }

    const bestMatch = searchResults[0];
    const queryLower = query.toLowerCase();
    
    // Apply reasoning chains
    for (const [chainName, chainFunction] of this.reasoningChains.entries()) {
      const reasoningResult = chainFunction(query, searchResults);
      if (reasoningResult) {
        return reasoningResult;
      }
    }
    
    // Multi-result synthesis for comparison queries
    if (searchResults.length > 1 && (queryLower.includes('compare') || queryLower.includes('difference') || queryLower.includes('vs'))) {
      return this.synthesizeComparison(searchResults);
    }
    
    // Context-aware single result responses
    if (bestMatch.type === 'service') {
      return this.generateServiceResponse(queryLower, bestMatch, searchResults);
    }
    
    if (bestMatch.type === 'hours') {
      return this.generateHoursResponse(queryLower, bestMatch);
    }
    
    if (bestMatch.type === 'location') {
      return this.generateLocationResponse(queryLower, bestMatch);
    }
    
    if (bestMatch.type === 'booking') {
      return this.generateBookingResponse(queryLower, bestMatch);
    }
    
    if (bestMatch.type === 'policy') {
      return this.generatePolicyResponse(queryLower, bestMatch);
    }
    
    return bestMatch.content;
  }

  // Generate service-specific responses
  generateServiceResponse(query, service, allResults) {
    let response = '';
    
    if (query.includes('price') || query.includes('cost')) {
      response = `${service.title} costs ${service.metadata.price}`;
      if (service.metadata.isVariablePrice) {
        response += ' (price may vary based on complexity and design choices)';
      }
      response += `. This ${service.metadata.complexity} ${service.metadata.luxuryLevel} service takes ${service.metadata.duration}.`;
    } else if (query.includes('time') || query.includes('long') || query.includes('duration')) {
      response = `${service.title} takes ${service.metadata.duration} to complete. `;
      if (service.metadata.durationMinutes >= 60) {
        response += 'This is a comprehensive service that ensures detailed attention to every aspect of your nails.';
      } else {
        response += 'This is perfect when you want professional results in a shorter timeframe.';
      }
    } else if (query.includes('recommend') || query.includes('good for')) {
      response = `${service.title} is ${service.metadata.luxuryLevel} and perfect for `;
      if (service.metadata.recommendedFor && service.metadata.recommendedFor.length > 0) {
        response += service.metadata.recommendedFor.join(' and ') + '.';
      } else {
        response += 'professional nail care.';
      }
    } else {
      response = service.content;
    }
    
    // Add helpful context
    if (service.metadata.category && !response.includes(service.metadata.category)) {
      response += ` This is part of our ${service.metadata.category} offerings.`;
    }
    
    return response;
  }

  // Generate hours-specific responses
  generateHoursResponse(query, hoursInfo) {
    if (query.includes('today') || query.includes('now')) {
      const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
      const todayHours = hoursInfo.metadata[today];
      if (todayHours && todayHours !== 'Closed') {
        return `Today (${today}) we're open from ${todayHours}. ${hoursInfo.content}`;
      } else {
        return `We're closed today (${today}). ${hoursInfo.content}`;
      }
    }
    
    if (query.includes('weekend')) {
      return `Weekend hours: Saturday ${hoursInfo.metadata.Saturday}, Sunday ${hoursInfo.metadata.Sunday}. ${hoursInfo.content}`;
    }
    
    return hoursInfo.content;
  }

  // Generate location-specific responses
  generateLocationResponse(query, locationInfo) {
    if (query.includes('direction') || query.includes('how to get')) {
      return `${locationInfo.content} We're easy to find in the Cheago Plaza - just look for Angellace beauty salon and we're inside at shop #4.`;
    }
    
    if (query.includes('parking') || query.includes('drive')) {
      return `${locationInfo.content} The Cheago Plaza on Wesley Road has convenient parking available.`;
    }
    
    return locationInfo.content;
  }

  // Generate booking-specific responses
  generateBookingResponse(query, bookingInfo) {
    if (query.includes('account') || query.includes('sign up')) {
      return `${bookingInfo.content} Creating an account is quick and helps us provide personalized service and track your appointment history.`;
    }
    
    if (query.includes('cancel') || query.includes('reschedule')) {
      return `${bookingInfo.content} Please note our reschedule policy: appointments can be rescheduled but not later than 24 hours before your scheduled time.`;
    }
    
    return bookingInfo.content;
  }

  // Generate policy-specific responses
  generatePolicyResponse(query, policyInfo) {
    let response = policyInfo.content;
    
    if (policyInfo.metadata.reasoning) {
      response += ` ${policyInfo.metadata.reasoning}`;
    }
    
    return response;
  }

  // Synthesize comparison between multiple results
  synthesizeComparison(results) {
    const services = results.filter(r => r.type === 'service');
    
    if (services.length >= 2) {
      const comparison = services.slice(0, 3).map(service => 
        `${service.title}: ${service.metadata.price} (${service.metadata.duration})`
      ).join(', ');
      
      return `Comparing our services: ${comparison}. Each offers different benefits - would you like detailed information about any specific service?`;
    }
    
    return results[0].content;
  }

  // Get policy reasoning for enhanced understanding
  getPolicyReasoning(policyType, policyText) {
    const reasoningMap = {
      reschedule: 'This policy ensures fair scheduling for all clients and allows our team to properly manage appointments.',
      discounts: 'We focus on providing consistent high-quality service at fair prices for everyone.',
      inspoImages: 'In-person consultation allows us to better understand your vision and provide professional recommendations.'
    };
    
    return reasoningMap[policyType] || 'This policy helps us provide the best possible service experience.';
  }

  // Assess policy strictness for reasoning
  assessPolicyStrictness(policyText) {
    if (policyText.includes('must') || policyText.includes('required') || policyText.includes('not later than')) {
      return 'strict';
    }
    if (policyText.includes('please') || policyText.includes('recommend')) {
      return 'flexible';
    }
    return 'moderate';
  }

  // Enhanced intent analysis with AI reasoning
  analyzeIntentWithAI(query) {
    const searchResults = this.semanticSearch(query, 5);
    
    let primaryIntent = 'general';
    let confidence = 0;
    let context = {};
    let reasoning = '';

    if (searchResults.length > 0) {
      const bestMatch = searchResults[0];
      confidence = bestMatch.relevanceScore;
      
      // Multi-layered intent detection
      switch (bestMatch.type) {
        case 'service':
          primaryIntent = 'service_inquiry';
          context.service = bestMatch;
          reasoning = `Detected service inquiry for ${bestMatch.title} with ${confidence.toFixed(1)}% confidence based on semantic matching.`;
          break;
        case 'hours':
          primaryIntent = 'hours_inquiry';
          reasoning = `Detected hours inquiry with ${confidence.toFixed(1)}% confidence based on time-related keywords.`;
          break;
        case 'location':
          primaryIntent = 'location_inquiry';
          reasoning = `Detected location inquiry with ${confidence.toFixed(1)}% confidence based on location keywords.`;
          break;
        case 'booking':
          primaryIntent = 'booking_inquiry';
          reasoning = `Detected booking inquiry with ${confidence.toFixed(1)}% confidence based on appointment-related terms.`;
          break;
        case 'policy':
          primaryIntent = 'policy_inquiry';
          context.policy = bestMatch.metadata.policyType;
          reasoning = `Detected policy inquiry about ${bestMatch.metadata.policyType} with ${confidence.toFixed(1)}% confidence.`;
          break;
        case 'comparison':
          primaryIntent = 'comparison_inquiry';
          reasoning = `Detected comparison request with ${confidence.toFixed(1)}% confidence based on comparative language.`;
          break;
      }
      
      // Secondary intent detection
      const queryLower = query.toLowerCase();
      if (queryLower.includes('recommend') || queryLower.includes('best') || queryLower.includes('suggest')) {
        context.needsRecommendation = true;
        reasoning += ' User seeks recommendations.';
      }
      
      if (queryLower.includes('compare') || queryLower.includes('difference') || queryLower.includes('vs')) {
        context.needsComparison = true;
        reasoning += ' User wants comparison.';
      }
    }

    return {
      primary: primaryIntent,
      confidence: confidence,
      context: context,
      searchResults: searchResults,
      reasoning: reasoning,
      queryComplexity: this.assessQueryComplexity(query),
      suggestedFollowUps: this.generateFollowUpSuggestions(primaryIntent, searchResults)
    };
  }

  // Assess query complexity for appropriate response depth
  assessQueryComplexity(query) {
    const words = query.split(' ').length;
    const questionWords = ['what', 'how', 'when', 'where', 'why', 'which', 'who'].filter(q => 
      query.toLowerCase().includes(q)
    ).length;
    const conjunctions = ['and', 'or', 'but', 'also', 'versus', 'vs'].filter(c => 
      query.toLowerCase().includes(c)
    ).length;
    
    if (words > 10 || questionWords > 1 || conjunctions > 0) return 'complex';
    if (words > 5 || questionWords === 1) return 'moderate';
    return 'simple';
  }

  // Generate intelligent follow-up suggestions
  generateFollowUpSuggestions(intent, results) {
    const suggestions = [];
    
    switch (intent) {
      case 'service_inquiry':
        suggestions.push('Would you like to know about pricing?', 'How long does this service take?', 'How do I book this service?');
        break;
      case 'hours_inquiry':
        suggestions.push('What services do you offer?', 'How do I book an appointment?', 'Where are you located?');
        break;
      case 'location_inquiry':
        suggestions.push('What are your opening hours?', 'How do I get directions?', 'Can I call for more information?');
        break;
      case 'booking_inquiry':
        suggestions.push('What services are available?', 'What are your prices?', 'Do I need to create an account?');
        break;
      default:
        suggestions.push('Tell me about your services', 'What are your hours?', 'How do I book an appointment?');
    }
    
    return suggestions.slice(0, 3);
  }

  // Performance monitoring
  getPerformanceMetrics() {
    return {
      knowledgeBaseSize: this.knowledgeBase.length,
      vocabularySize: this.vocabulary.size,
      cacheSize: this.queryCache.size,
      conceptGraphSize: this.conceptGraph.size,
      initialized: this.initialized
    };
  }
}

// Initialize Advanced AI
const AI = new AdvancedAISearchEngine();

// ============================================
// ENHANCED CHATBOT WITH ADVANCED AI REASONING
// ============================================

// Enhanced conversation context for advanced reasoning
let chatContext = {
  lastTopic: null,
  lastService: null,
  lastIntent: null,
  expectingFollowUp: false,
  conversationHistory: [],
  userPreferences: {},
  sessionStartTime: Date.now(),
  queryCount: 0
};

// Enhanced intent detection function (fallback)
function analyzeIntent(text) {
  const intents = {
    pricing: /price|cost|much|expensive|cheap|fee|charge|money|budget/,
    duration: /long|time|duration|take.*minutes|how.*long|minutes|hours|quick|fast/,
    booking: /book|appointment|schedule|reserve|available|appointment/,
    location: /where|location|address|direction|find|situated|located/,
    contact: /phone|call|contact|number|reach|telephone/,
    hours: /hours|open|close|when.*open|operating|schedule/,
    services: /service|what.*do|offer|available|nail|treatment/,
    social: /instagram|tiktok|social|follow|social media/,
    comparison: /compare|difference|better|best|versus|vs|which.*better/,
    recommendation: /recommend|suggest|best|good for|should.*get|advice/
  };

  for (const [intent, pattern] of Object.entries(intents)) {
    if (pattern.test(text.toLowerCase())) {
      return intent;
    }
  }
  return 'general';
}

// Enhanced Chatbot Functions
function toggleChat() {
  const window = document.getElementById('chatbot-window');
  const icon = document.getElementById('chatbot-icon');
  
  if (window && icon) {
    if (window.style.display === 'flex') {
      closeChat();
    } else {
      window.style.display = 'flex';
      icon.textContent = '×';
      const input = document.getElementById('chatbot-input');
      if (input) input.focus();
      
      // Add welcome message if first time opening
      if (chatContext.queryCount === 0) {
        setTimeout(() => {
          addChatMessage(`Hello! I'm your AI assistant for ${CHATBOT_CONFIG.businessName}. I can help you with services, pricing, booking, and more. What would you like to know?`, 'bot');
        }, 500);
      }
    }
  }
}

function closeChat() {
  const window = document.getElementById('chatbot-window');
  const icon = document.getElementById('chatbot-icon');
  
  if (window && icon) {
    window.style.display = 'none';
    icon.textContent = '💬';
  }
}

function handleChatKeyPress(event) {
  if (event.key === 'Enter') {
    sendChatMessage();
  }
}

function sendChatMessage() {
  const input = document.getElementById('chatbot-input');
  const message = input ? input.value.trim() : '';
  
  if (!message) return;
  
  addChatMessage(message, 'user');
  if (input) input.value = '';
  
  // Update conversation context
  chatContext.queryCount++;
  chatContext.conversationHistory.push({
    role: 'user',
    message: message,
    timestamp: Date.now(),
    queryNumber: chatContext.queryCount
  });
  
  showTypingIndicator();
  
  // Variable response time for more natural feeling
  const responseTime = 1000 + Math.random() * 1000;
  
  setTimeout(() => {
    hideTypingIndicator();
    const response = generateAdvancedChatResponse(message);
    addChatMessage(response, 'bot');
    
    // Add response to history
    chatContext.conversationHistory.push({
      role: 'bot',
      message: response,
      timestamp: Date.now()
    });
  }, responseTime);
}

function addChatMessage(message, sender) {
  const messagesContainer = document.getElementById('chatbot-messages');
  if (!messagesContainer) return;
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `chatbot-message ${sender}`;
  
  // Format message with line breaks and preserve structure
  const formattedMessage = message
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>');
    
  messageDiv.innerHTML = `
    <div class="message-content">${formattedMessage}</div>
    <div class="message-timestamp">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
  `;
  
  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
  const messagesContainer = document.getElementById('chatbot-messages');
  if (!messagesContainer) return;
  
  const typingDiv = document.createElement('div');
  typingDiv.className = 'chatbot-message bot';
  typingDiv.id = 'typing-indicator';
  
  typingDiv.innerHTML = `
    <div class="chatbot-typing">
      <span></span>
      <span></span>
      <span></span>
    </div>
  `;
  
  messagesContainer.appendChild(typingDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
  const typingIndicator = document.getElementById('typing-indicator');
  if (typingIndicator) {
    typingIndicator.remove();
  }
}

// Enhanced spell check and text normalization
function normalizeText(text) {
  const corrections = {
    // Common typos
    'hrs': 'hours', 'hr': 'hour', 'opning': 'opening', 'oepn': 'open',
    'wher': 'where', 'wat': 'what', 'hw': 'how', 'servies': 'services',
    'pric': 'price', 'cosr': 'cost', 'instgram': 'instagram', 'tiktoc': 'tiktok',
    'bokking': 'booking', 'acount': 'account', 'apointment': 'appointment',
    'mancure': 'manicure', 'pedicur': 'pedicure', 'acrilic': 'acrylic',
    'nales': 'nails', 'locaton': 'location', 'adress': 'address',
    'reschedual': 'reschedule', 'reshedule': 'reschedule', 'contac': 'contact',
    'discunt': 'discount', 'discont': 'discount', 'inspiraton': 'inspiration',
    'inspo': 'inspiration', 'pic': 'picture', 'foto': 'photo',
    // Business-specific corrections
    'mandvile': 'mandeville', 'jamaca': 'jamaica', 'jamiaca': 'jamaica',
    'cheago': 'cheago', 'angellase': 'angellace', 'naviluxe': 'nailuxe'
  };
  
  let normalized = text.toLowerCase();
  Object.entries(corrections).forEach(([wrong, correct]) => {
    normalized = normalized.replace(new RegExp(`\\b${wrong}\\b`, 'g'), correct);
  });
  
  return normalized;
}

// Enhanced context-aware response system
function isFollowUpQuestion(text) {
  const followUpIndicators = [
    'what about', 'how about', 'and', 'also', 'too', 'as well',
    'other', 'different', 'another', 'else', 'more', 'any', 'tell me about'
  ];
  
  const hasIndicator = followUpIndicators.some(indicator => text.toLowerCase().includes(indicator));
  const isShort = text.split(' ').length < 8;
  
  return hasIndicator && isShort;
}

// MAIN ADVANCED AI-ENHANCED RESPONSE GENERATOR
function generateAdvancedChatResponse(message) {
  const normalized = normalizeText(message);
  
  // Use Advanced AI for comprehensive analysis
  const aiAnalysis = AI.analyzeIntentWithAI(normalized);
  const fallbackIntent = analyzeIntent(normalized);
  
  // Determine if we should use AI results
  const useAI = aiAnalysis.confidence > 25; // Lower threshold for better coverage
  const intent = useAI ? aiAnalysis.primary : fallbackIntent;
  
  console.log('Advanced AI Analysis:', {
    query: normalized,
    intent: intent,
    confidence: aiAnalysis.confidence,
    useAI: useAI,
    complexity: aiAnalysis.queryComplexity,
    resultsCount: aiAnalysis.searchResults.length
  });
  
  // Update chat context
  chatContext.lastTopic = intent;
  chatContext.lastIntent = aiAnalysis;
  
  // Handle contextual follow-up questions
  if (chatContext.expectingFollowUp && isFollowUpQuestion(normalized)) {
    chatContext.expectingFollowUp = false;
    
    if (useAI && aiAnalysis.searchResults.length > 0) {
      const contextualResponse = AI.generateIntelligentResponse(normalized, aiAnalysis.searchResults);
      if (contextualResponse) return contextualResponse;
    }
    
    return generateContextualFollowUp(normalized);
  }
  
  // AI-Generated responses for high-confidence matches
  if (useAI && aiAnalysis.searchResults.length > 0) {
    const aiResponse = AI.generateIntelligentResponse(normalized, aiAnalysis.searchResults);
    if (aiResponse) {
      chatContext.expectingFollowUp = true;
      
      // Add follow-up suggestions for complex queries
      if (aiAnalysis.queryComplexity === 'complex' && aiAnalysis.suggestedFollowUps.length > 0) {
        const suggestions = aiAnalysis.suggestedFollowUps.slice(0, 2).join(' or ');
        return `${aiResponse}\n\nWould you like to know: ${suggestions}?`;
      }
      
      return aiResponse;
    }
  }
  
  // Enhanced greeting responses with personalization
  if (normalized.match(/^(hi|hello|hey|good morning|good afternoon|good evening)/)) {
    chatContext.lastTopic = 'greeting';
    const greetings = [
      `Hello! Welcome to ${CHATBOT_CONFIG.businessName}! I'm here to help with all your nail care questions. What can I assist you with today?`,
      `Hi there! Thanks for visiting ${CHATBOT_CONFIG.businessName}. I can help you with services, pricing, booking, and more. How can I help?`,
      `Good day! I'm your AI assistant for ${CHATBOT_CONFIG.businessName}. Feel free to ask about our services, hours, location, or booking process!`
    ];
    return greetings[Math.floor(Math.random() * greetings.length)];
  }
  
  // Enhanced thank you/goodbye with session summary
  if (normalized.match(/(thank|thanks|bye|goodbye|see you)/)) {
    let response = `You're very welcome! Thank you for choosing ${CHATBOT_CONFIG.businessName}!`;
    
    if (chatContext.queryCount > 1) {
      response += ` I hope I was able to help with your ${chatContext.queryCount} questions today.`;
    }
    
    response += ` Have a beautiful day and we look forward to seeing you soon! 💅`;
    
    // Reset context
    chatContext = { 
      lastTopic: null, 
      lastService: null, 
      lastIntent: null,
      expectingFollowUp: false, 
      conversationHistory: [], 
      userPreferences: {},
      sessionStartTime: Date.now(),
      queryCount: 0
    };
    
    return response;
  }
  
  // Enhanced contextual responses for unclear messages
  if (chatContext.lastTopic && !useAI) {
    return generateContextualGuidance(chatContext.lastTopic, normalized);
  }
  
  // Smart fallback responses with AI reasoning
  chatContext.expectingFollowUp = true;
  
  const smartDefaults = [
    `I'd love to help! I can provide information about our nail services, pricing, appointment booking, opening hours, location, and policies. What interests you most?`,
    `I'm here to assist with everything about ${CHATBOT_CONFIG.businessName}! Try asking about specific services, prices, our schedule, how to book, or our location.`,
    `Let me help you find what you need! I can explain our services (manicures, pedicures, gel, acrylics), pricing, booking process, hours, or location. What would you like to know?`
  ];
  
  return smartDefaults[chatContext.queryCount % smartDefaults.length];
}

// Generate contextual follow-up responses
function generateContextualFollowUp(query) {
  if (chatContext.lastIntent && chatContext.lastIntent.searchResults.length > 1) {
    const additionalResults = chatContext.lastIntent.searchResults.slice(1, 3);
    const suggestions = additionalResults.map(r => r.title).join(', ');
    return `Based on your question, you might also be interested in: ${suggestions}. Would you like details about any of these?`;
  }
  
  return "I'd be happy to provide more information! What specific aspect would you like to know about?";
}

// Generate contextual guidance based on conversation history
function generateContextualGuidance(lastTopic, query) {
  const guidanceMap = {
    'service_inquiry': `I can help you learn more about that service! Try asking about pricing, duration, booking process, or what makes it special.`,
    'hours_inquiry': `Besides our hours, I can also help with booking appointments, service information, or directions to our location.`,
    'location_inquiry': `Along with location details, I can provide directions, parking information, or help you book an appointment.`,
    'booking_inquiry': `I can guide you through booking! I can also explain our services, pricing, or policies to help you decide.`,
    'pricing': `For pricing questions, I can compare services, explain what's included, or help you find options in your budget.`,
    'comparison_inquiry': `I can help compare our services by price, duration, results, or what's best for specific occasions.`
  };
  
  const guidance = guidanceMap[lastTopic] || `I didn't quite understand "${query}". How else can I assist you today?`;
  chatContext.expectingFollowUp = false;
  return guidance;
                     }

  </script>
</body>
</html>
